<!DOCTYPE html>
<html lang="en">
<head>
	<title>SPITFIRE WebTAsX</title>
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/style.css" rel="stylesheet">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script src="js/require.js"></script>

	<!-- Page core -->
	<script src="js/jquery-latest.js"></script>
	<script src="js/bootstrap.min.js"></script>

	<script>

		// Set up requirejs
		requirejs.config({
			"baseUrl": "js",
			"paths": {
			    "jquery" : "jquery-latest.min",
				"bootstrap": "bootstrap.min"
			},
			// Dependencies
			"shim": {
			    "jquery": {
			        "exports": "$"
			    },
				"bootstrap" : ["jquery"]
			}
		});

		// requirejs init
		require(
			["SPARQL", "logic", "config", "jquery", "functions", "alert", "once", "periodically"],
			function(SPARQL, Logic) {

				// Keeps the last generated queries
				var query = null;
	
				// Keeps all queries
				// [x][0] The SPARQL query
				// [x][1] Textual description
				// [x][2] Action command, e.g. ON/OFF
				// [x][3] Interval event
				var queries = [];

				function init () {

					// Get the last SPARQL queries
					var query1 = localStorage.getItem("query1");
					if(query1 != null) {
						$('#query-text1').val(query1);
					}

					var query2 = localStorage.getItem("query2");
					if(query2 != null) {
						$('#query-text2').val(query2);
					}

					// Get all saves queries to rerun them
					var saved_queries = localStorage.getItem("saved_queries");
					if(saved_queries != null && saved_queries != "null") {
						var queries2 = JSON.parse(saved_queries);
						for(var i =0; i<queries2.length;i++) {	
							var q = queries2[i];
							if(q != null) {
								queries.push(q);
								run_queries_periodically(q[0], q[2], queries.length-1);
							}
						}
						update_storage();
					}

					// Set up tab
					createTabWebTasx();

					// Add event listeners
					document.getElementById('query-start').addEventListener('click', query_start, false);
					document.getElementById('query-restart').addEventListener('click', query_start, false);
					document.getElementById('action-start').addEventListener('click', action_start, false);

					// Handle click on saveconfig button
					$("#saveConfig").click(function() {
						for (var key in config){
							var id = "config-" + key;
							var input = $("#" + id);
							var value = input.val();
							localStorage.setItem(key, value);
						}
						alert("Successful");
					});

					// Results
					$("#query-result-rules").html(create_info("No result yet."));
					$("#query-result-actors").html(create_info("No result yet."));
				}

				function update_storage() {
					var ul = $("<ul>");
					for(var i = 0; i < queries.length; i++) {
						var q = queries[i];
						if(q == null) continue;

						// Generate LI
						var li = $("<li>");
						var del_img = $("<img style=\"cursor:pointer;\" src=\"img/cancel.png\">");
						var onClick = function(i) {
							return function() {
								if(queries[i] != null) {
									clearTimeout(queries[i][3]);
									//queries.remove(i);
									queries[i] = null;
									localStorage['saved_queries'] = JSON.stringify(queries);
									update_storage();
								}
							}
						};

						del_img.click(onClick(i));
						li.append(del_img);
						li.append(" " + q[1]);
						// Add LI
						ul.append(li);
					}
					$("#storage").html(ul);
				}

				function update(x) {
					/*
					console.log("----------------------------------------------------------------------------------")
					console.log(x);
					console.log("----------------------------------------------------------------------------------")
					console.info("SPARQL rules:");
					var query_rules = generate_sparql($("#rules .query-spo"), $("#no-rule-msg1"));
					console.info("SPARQL actors:");
					var query_actions = generate_sparql($("#actuation .query-spo"), $("#no-rule-msg2"));

					if(query_rules.query.length > 0 && query_actions.query.length > 0) {
						var q = "SELECT * WHERE { " + query_rules.query + " UNION " + query_actions.query + " }";
						localStorage.setItem("query", q);
					}

					// Update the text field
					$("#query-text1").val(q);
					query = [q, query_rules, query_actions];
					*/
				}

				/*
				 * This function creates the WebTAsX-tab
				 */
				function createTabWebTasx() {
					// Add new menu
					var li = $('<li><a href="#tabWebTAsX" data-toggle="tab">WebTAsX</a></li>');
					$("#tab-tabs li:last").after(li);

					// Add new content pane
					var div = $("<div class=\"tab-pane\" id=\"tabWebTAsX\" style=\"min-height:250px;\"></div>");
					$("#tab-content").append(div);

					// set active
					div.addClass("active");
					li.addClass("active");

					// #################################################################
					// RULES
					// #################################################################

					var outputRules = $("<div></div>");
					var div_selection = $("<div id=\"rules\"></div>");
					var div_actuation = $("<div style=\"margin-top:5px;\"></div>");

					div.append("<h4>Rules</h4>");
					div.append(div_selection);
					div_selection.append(outputRules);


					var rules = new Logic(outputRules, div_selection);
					rules.init();

					// #################################################################
					// ACTUCATORS
					// #################################################################

					div.append("<h4>Actuators</h4>");
					div.append(div_actuation);		
					var SPARQL_actuators = new SPARQL(div_actuation);
					SPARQL_actuators.init("actuation", false);

					// Create a div to keep the save stuff and add it to the content pane
					var form = $('<form class="form-horizontal">');
					div.append(form);

					// #################################################################
					// ACTION
					// #################################################################

					form.append("<h4>Action</h4>");
					var div_action = $("<div style=\"margin-top:5px;\" class=\"control-group\"></div>"); // <label class=\"control-label\">Action:</label>
					var div_action_controls = $('<div class="controls"></div>');
					var select_action = $("<select id=\"action-value\"></select>");
					select_action.append($("<option value=\"on\">on</option>"));
					select_action.append($("<option value=\"off\">off</option>"));
					select_action.append($("<option value=\"toggle\">toggle</option>"));
					form.append(div_action)
					div_action.append(div_action_controls);
					div_action_controls.append(select_action);

					// #################################################################
					// TASK
					// #################################################################

					form.append("<h4>Task</h4>");

					var div_rule = $("<div style=\"margin-top:5px;\" class=\"control-group\"><label class=\"control-label\">Task Name:</label></div>");
					var div_rule_controls = $('<div class="controls"></div>');
					form.append(div_rule)
					div_rule.append(div_rule_controls);
					var input_rule_text = $("<input type=\"text\" placeholder=\"Task name...\" class=\"span6\">");
					div_rule_controls.append(input_rule_text);

					var div_button = $("<div style=\"margin-top:5px;\" class=\"control-group\"></div>");
					var div_button_controls = $('<div class="controls"></div>');
					var input_button_start_task = $("<button class=\"btn\" type=\"button\">Start task</button>");

					form.append(div_button)
					div_button.append(div_button_controls);
					div_button_controls.append(input_button_start_task);

					input_button_start_task.click(function() {
						 save_queries_to_localstorage();
							/*
							// XXX
							if(query == null) {
								alert("You need at least one rule to run the query.");
								return;
							}
							if(input_rule_text.val().length == 0) {
								alert("You need a task name to run the query.");
								return;
							}

							$("#tab-storage-link").click();

							// XXX
							var idx = queries.push([query, input_rule_text.val(), select_action.val(), null]);
							localStorage['saved_queries'] = JSON.stringify(queries);
							update_storage();
							// XXX
							run_queries_periodically(query, select_action.val(), idx-1);
							*/
						}
					);
					
					// Generates the queries
					function save_queries_to_localstorage() {
						try{
							// RULES query
							var q1 = rules.query();
							console.info("SPARQL rules:");
							console.log(q1);

							// ACTUATORS query
							var query_actuators = SPARQL_actuators.getSparql();
							if(typeof(query_actuators) == "undefined") {
								throw ("Actuators have no triples!")
							} else if(typeof(query_actuators) == "object" && !query_actuators.hasActuator) {
								throw ("Actuators triples define no actuators!")						
							} else {
								var q2 = query_actuators.prefixes + "\n" + "SELECT " + implode(" ", query_actuators.selections) + " WHERE {\n " + query_actuators.query + " }\n";
								console.info("SPARQL actuators:");
								console.log(q2);
							}

							// Save the queries to the localStorage
							localStorage.setItem("query1", q1);
							$("#query-text1").val(q1);

							localStorage.setItem("query2", q2);
							$("#query-text2").val(q2);

						} catch(e) {
							alert(e);
						}

					}
				}

				// #############################################################
				// Todo from here!
				// #############################################################
	
				var eval = [];
				function run_queries_periodically(queries2, action, index) {

					//eval[index] = [];
					//eval.push

					var redoTimeout = 2000;

					var start = 0;
					function succ1(res) {
						if(typeof(res.res) == "string") {

							/*
							success_periodically(res, action);

							var elapsed = new Date().getTime() - start;
							console.log("elapsed: " + elapsed);

							var rest = redoTimeout - elapsed;
							console.log("rest: " + rest);

							if(rest <= 0) {
								rest = 0;
								console.log("Redo queries NOW!");
							} else {
								console.log("Redo queries in " + rest + "ms");
							}

							// Not stpped yet
							if(queries[index] != null) {
								queries[index][3] = setTimeout(funPerInterval1, rest);
							}
							*/
						}
					}

					var funPerInterval1 = function () {
						start = new Date().getTime();
						run_queries_once(queries2, succ1, error_periodically, function() {})
					}

					// Initial...
					queries[index][3] = setTimeout(funPerInterval1, 0);
				}

				function doAction(url, action) {
					url = config['sparqlEndpoint'] + "/?uri=" + url;
					console.log("RUN ACTION ON " + url + " :: " + action);
		
					var xhr = new XMLHttpRequest();
					xhr.open('POST', url, true);
					xhr.responsetype = "text";

					xhr.onload = function(e) {

						// ##############################################
						// EVALUATION
						// ##############################################

						var key = "action-" + url + "-" + action;
						if (this.readyState == 4 && this.status == 200) {
							var elapsed = new Date().getTime() - start;
							var e = localStorage.getItem("eval-action");
							var result = new Object();
							if(e != null) {
								result = JSON.parse(e);	
							}
							if(typeof(result[key]) == "undefined") {
								result[key] = [];
							}
							result[key].push(elapsed);
							localStorage.setItem("eval-action", JSON.stringify(result));
						}

						// ##############################################
						// EVALUATION
						// ##############################################

						lastStatus = this.status;
						// 200 ok
						// 201 created
						// 204 non content
						if (!(this.readyState == 4 && (this.status == 200 || this.status == 201 || this.status == 204))) {
							console.log(url + " + " + action + " ERROR - STATUS: " + this.status);
						}
					}
					var start = new Date().getTime();
					xhr.send(action);
				}

				// Run action on url
				function action_request(url, action) {
					if(action == null) return;
					var query = "SELECT DISTINCT ?o WHERE { <" + url + "> <http://spitfire-project.eu/ontology/ns/value> ?o }";

					var onsuccess = function(res) {

						var dom = new DOMParser().parseFromString(res,'text/xml');
						var variables = dom.getElementsByTagName("literal");
						for(var i = 0; i < variables.length; i++) {
							var variable = variables[i];
							var value = variable.childNodes[0].data;

							if(parseInt(value) == 1 && action == "toggle") {
								console.log("TOGGLE TO OFF!");
								doAction(url, "off");
							} else if(parseInt(value) == 0 && action == "toggle" ) {
								console.log("TOGGLE TO ON!");
								doAction(url, "on");
							} else if(parseInt(value) == 1 && action == "off" || parseInt(value) == 0 && action == "on" ) {
								doAction(url, action);
							} 
						}
					}

					var sparql_url = config['sparqlEndpoint'];
					execute_sparql_query(sparql_url, query, onsuccess);

				}

				// Run action for selected actors from Result
				function action_start() {
					var e = $("td.marked");
					for (var i = 0, i; i < e.length; i++) {
						var child = e[i].firstChild;
						action_request(child.data, $('#action-value').val());
					}
				}

				// Run querys from Query-Textbox
				function query_start() {
					var q1 = new Object();
					q1.query = $("#query-text1").val();

					var q2 = new Object();
					q2.query = $("#query-text2").val();
					q2.hasActuator = true;

					run_queries_once([q1,q2], requestHandlerOnce.success_once, requestHandlerOnce.error_once, requestHandlerOnce.async_once);
				}
		 
				// Run a query once
				function run_queries_once(queries, onsuccess, onerror, onasync, filter) {

					if(queries[0].query == null) {
						alert("You need at least one selection rule to run the query.");
						return;				
					} else if(queries[1].query == null) {
						alert("You need at least one actuation rule to run the query.");
						return;				
					} else if(!queries[1].hasActuator) {
						alert("You need to define at least one actuator.");
						return;				
					}

					var succData = new Object();
					var url = config['sparqlEndpoint'];

					if(queries[0].query.length > 0 && queries[1].query.length > 0) {
						var q = "SELECT * WHERE { " + queries[0].query + " UNION " + queries[1].query + " }";
						localStorage.setItem("query", q);
					}
		
					var onsuccessQ = function (res) {
						succData.res = res;
						onsuccess(succData, queries);
					}
		
					execute_sparql_query(url, q, onsuccessQ);

					if(typeof(onasync) == "function") {
						onasync();
					}
				}

				function execute_sparql_query(url, query, onsuccess) {

					// #################################################################
					// SSP with Apache Jena/SDB RESTful interface
					// POST query on /sparql
					// #################################################################

					var xhr = new XMLHttpRequest();
					xhr.responsetype = "text";
					xhr.open('POST', url + "/sparql", true);
					xhr.onload = function(e) {
						// The response type is "SPARQL Query Results XML Format (Second Edition)"
						// http://www.w3.org/TR/rdf-sparql-XMLres/
						if (this.readyState == 4 && this.status == 200) {

							// ##############################################
							// EVALUATION
							// ##############################################

							var elapsed = new Date().getTime() - start;
							console.log(query + ":" + elapsed);
							var e = localStorage.getItem("eval-queries");
							var result = new Object();
							if(e != null) {
								result = JSON.parse(e);	
							}
							if(typeof(result[query]) == "undefined") {
								result[query] = [];
							}
							result[query].push(elapsed);
							localStorage.setItem("eval-queries", JSON.stringify(result));

							// ##############################################
							// EVALUATION
							// ##############################################


							if(typeof(onsuccess) == "function") {
								onsuccess(this.response);
							}
						} else if (this.readyState == 4){
							console.log("Some error...");
						}
					}

					var start = new Date().getTime();
					xhr.send(query);

					// #################################################################
					// Sesame RESTful interface
					// GET with query in query param
					// #################################################################
					/*
					var encoded = urlencode(query);
					var path = url + "?query=" + encoded;

					var xhr = new XMLHttpRequest();
					xhr.responsetype = "text";
					xhr.open('GET', path, true);
					xhr.setRequestHeader("Accept", "application/xml");
					xhr.onload = function(e) {

						// The result type is "SPARQL Query Results XML Format (Second Edition)"
						// http://www.w3.org/TR/rdf-sparql-XMLres/
						if (this.readyState == 4 && this.status == 200) {
							if(typeof(onsuccess) == "function") {
								onsuccess(this.response);
							}
						} else if (this.readyState == 4){
							console.log("Some error...");
						}
			
		//				TODO: Error handling
		//				else if (this.status == 504) {
		//					if(typeof(onerror) == "function") {
		//						onerror("CoAP timeout.");
		//					}
		//				} else {
		//					if(typeof(onerror) == "function") {
		//						onerror("HTTP-Status: " + this.status);
		//					}
		//				} 
					}
					xhr.send(null);
					// #################################################################
					*/
				}


				init();
			}
		);

	</script>
</head>
<body>

	<div class="container">
			<h1>SPITFIRE WebTAsX</h1>
			<ul class="nav nav-tabs" id="tab-tabs">
				<!--
				<li><a href="#tab-import" data-toggle="tab">Module Import</a></li>
				<li><a href="#tab-config" data-toggle="tab">Config</a></grepli>
				<li><a id="tab-storage-link" href="#tab-storage" data-toggle="tab">Storage</a></li>
				<li><a id="tab-result-link" href="#tab-result" data-toggle="tab">Result</a></li>
				-->
				<li><a href="#tab-query" data-toggle="tab">Query-Textbox</a></li>
			</ul>
			<div class="tab-content" id="tab-content">
				<div class="tab-pane" id="tab-query">
					<h3>Query</h3>
					<h4>Rules Query</h4>
					<textarea id="query-text1" style="width:97%;height:250px;"></textarea><br>
					<h4>Actors Query</h4>
					<textarea id="query-text2" style="width:97%;height:250px;"></textarea><br>
					<p><input class="btn" type="button" id="query-start" value="Run Query"></p>
				</div>
				<div class="tab-pane" id="tab-storage">
					<h3>Storage</h3>
					<p id="storage">...</p>
				</div>
				<div class="tab-pane" id="tab-config">
					<h3>Configuration</h3>
					<form class="form-horizontal">
					  <div class="control-group">
						<label for="config-lightThreshold" class="control-label">Light threshold:</label>
						<div class="controls">
						  <input type="text" placeholder="Threshold" id="config-lightThreshold">
						</div>
					  </div>
					  <div class="control-group">
						<label for="config-sparqlEndpoint" class="control-label">Sparql endpoint:</label>
						<div class="controls">
						  <input type="text" placeholder="http://..." id="config-sparqlEndpoint">
						</div>
					  </div>
					  <div class="control-group">
						<div class="controls">
						  <input type="input" id="saveConfig" class="btn" value="Save">
						</div>
					  </div>
					</form>					
				</div>
				<div class="tab-pane" id="tab-result">
					<h3>Result</h3>
					<p><input class="btn" type="button" id="query-restart" value="Rerun Query"></p>
					<h4>Result rules</h4>
					<p id="query-result-rules"></p>

					<h4>Result actors</h4>
					<p id="query-result-actors"></p>
					<h3>Actuation</h3>
					<p>
						<select id="action-value">
							<option value="on">on</option>
							<option value="off">off</option>
							<option value="toggle">toggle</option>
						</select>
						<br>
						<button class="btn" type="button" id="action-start">Run Actuation</button>
					</p>
				</div>
			</div>
	</div>

</body>
</html>
