<!DOCTYPE html>
<html lang="en">
<head>
	<title>SPARQL Editor</title>
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/style.css" rel="stylesheet">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script src="js/require.js"></script>

	<!-- Page core -->
	<script src="js/jquery-latest.js"></script>
	<script src="js/bootstrap.min.js"></script>

	<script>

		requirejs.config({
			baseUrl: 'js',
			paths: {
			    jquery : "jquery-latest.min",
				bootstrap: 'bootstrap.min'
			},
			// Dependencies
			shim: {
			    jquery: {
			        exports: "$"
			    },
				bootstrap : ['jquery']
			}
		});

		require(
			['config', 'modules', 'jquery', 'urlencode', 'remove', 'alert', 'dnd', 'once', 'periodically'],
			function(foo, modules) {
				init(modules);
			}
		);

		// Keeps the last action on an actor
		var lastAction = new Object();

		// Keeps the last generated queries
		var query = null;
		
		// Keeps all queries
		// [x][0] The SPARQL query
		// [x][1] Textual description
		// [x][2] Action command, e.g. ON/OFF
		// [x][3] Interval event
		var queries = [];
		var modid = 0;

		function init (modules) {

			// Get the last SPARQL query
			var query1 = localStorage.getItem("query1");
			if(query1 != null) {
				$('#query-text1').val(query1);
			}
			var query2 = localStorage.getItem("query2");
			if(query2 != null) {
				$('#query-text2').val(query2);
			}

			// Get all saves queries to rerun them
			var saved_queries = localStorage.getItem("saved_queries");
			if(saved_queries != null && saved_queries != "null") {
				queries = JSON.parse(saved_queries);
				update_storage();
				for(var i =0; i<queries.length;i++) {	
					var q = queries[i];
					run_query_periodically(q[0], q[2], i);
				}
			}

			// Add modules
			addModules([modules]); //weather_module,modul2,modul3

			// Add event listeners
			//document.getElementById('files').addEventListener('change', handleFileSelect, false);
			document.getElementById('query-start').addEventListener('click', query_start, false);
			document.getElementById('query-restart').addEventListener('click', query_start, false);
			document.getElementById('action-start').addEventListener('click', action_start, false);

			$("#saveConfig").click(function() {
				for (var key in config){
					var id = "config-" + key;
					var input = $("#" + id);
					var value = input.val();
					localStorage.setItem(key, value);
				}
				alert("Successful");
			});

			$("#query-result-rules").html(create_info("No result yet."));
			$("#query-result-actors").html(create_info("No result yet."));
		}



		function update_storage() {
			var ul = $("<ul>");
			for(var i = 0; i < queries.length; i++) {
				var q = queries[i];

				// Generate LI
				var li = $("<li>");
				var del_img = $("<img style=\"cursor:pointer;\" src=\"img/cancel.png\">");
				var onClick = function(i) {
					return function() {
						clearInterval(queries[i][3]);
						queries.remove(i);
						localStorage['saved_queries'] = JSON.stringify(queries);
						update_storage();
					}
				};

				del_img.click(onClick(i));
				li.append(del_img);
				li.append(" " + q[1]);
				// Add LI
				ul.append(li);
			}
			$("#storage").html(ul);
		}

		function update(x) {
			console.log("----------------------------------------------------------------------------------")
			console.log(x);
			console.log("----------------------------------------------------------------------------------")
			console.info("SPARQL rules:");
			var query_rules = generate_sparql($("#rules .query-spo"), $("#no-rule-msg1"));
			console.info("SPARQL actors:");
			var query_actions = generate_sparql($("#actuation .query-spo"), $("#no-rule-msg2"));

			// Update the text field
			$("#query-text1").val(query_rules.query);
			$("#query-text2").val(query_actions.query);

			// 
			query = [query_rules, query_actions];
		}

		// o[0] what to show
		// o[1] what to map
		// o[2] 
		// o[3] preselected
		// event changeevent
		function generate_select(o, event, str) {
			var select = $('<select></select>');

			for(var j = 0; j<o.length; j++) {

				if(typeof(o[j]) == "undefined") {
					console.log("ERROR");
				}

				var option = "<option value=\"" + o[j][1] + "\" ";

				if(typeof(str) == "string" && typeof(o[j][2]) == "string") {
					option += "" + str + "=\"" + o[j][2] + "\" ";			
				}

				if(o[j][3] == true) {
					option += " selected";
				}
				option += ">" + o[j][0] + "</option>";
				select.append(option);
			}
			if(typeof(event) == "function") {
				select.change(event);
			}
			return select;
		}

		function addModules(modules) {
			for(var i = 0; i < modules.length; i++) {
				addModule(modules[i]);
			}
		}

		function addModule(module) {
			modid++;

			var lineid = 0;

			var create = function(s_mapping, s) {

				var spo_id = "spo" + (lineid++);
				var div_spo = $("<div id=\"" + spo_id + "\" class=\"query-spo\"></div>");
				
				createimg = function() {
					return $("<img class=\"dnd\" src=\"img/arrow_in.png\">");
				}

				// SPO-divs
				var div_s = $("<div id=\"s" + lineid + "\" draggable=\"true\" class=\"box\"></div>"); //  style=\"padding:2px; border: 2px solid red;\"
				var div_p = $("<div id=\"p" + lineid + "\" draggable=\"true\" class=\"box\"></div>"); //  style=\"padding:2px; border: 2px solid blue;\"
				var div_o = $("<div id=\"o" + lineid + "\" draggable=\"true\" class=\"box\"></div>"); //  style=\"padding:2px; border: 2px solid green;\"

				var create_dnd = function(div) {
					// By dnd.js file
					div.bind('dragstart', dnd.handleDragStart);
					div.bind('dragend', dnd.handleDragEnd);
					div.bind('dragover', dnd.handleDragOver);
					div.bind('drop', dnd.handleDrop);
				}  

				create_dnd(div_s);
				create_dnd(div_p);
				create_dnd(div_o);

				var div_del = $("<span></span>");
				
				var del_img = $("<img style=\"cursor:pointer;\" src=\"img/cancel.png\">");
				del_img.click(function() { 
					$("#" + spo_id).remove();
					update("del_img.click");
				});
				div_del.append(del_img);

				// Append SPO-divs to main div
				div_spo.append(div_s);
				div_spo.append(div_p);
				div_spo.append(div_o);
				div_spo.append(div_del);

				var s_change = function() {
					var s_text = select_s.find("option:selected").text();

					for(var i = 0; i<s_mapping.length; i++) {
						if(s_mapping[i][0] == s_text) {
							var p_mapping = s_mapping[i][2];

							var p_change = function(e){
								var text = select_p.find("option:selected").text();
								var select_o = null;
								for(var i = 0; i<p_mapping.length; i++) {
									if(p_mapping[i][0] == text) {
										var o_change = function(e){
											update("o_change");
										};
										var o_mapping = p_mapping[i][2];

										if(typeof(o_mapping) == "undefined") {
											select_o = generate_select([["?","?"]], o_change);
										} else {
											select_o = generate_select(o_mapping, o_change, "actors");
										}
									}
								}
								div_o.empty();
								div_o.append(select_o);
								update("p_change");
							};
							var select_p = generate_select(p_mapping, p_change, "actors");
							div_p.empty();
							div_p.append(select_p);

							// Empty select for O
							var select_o = $('<select class="o"></select>');
							select_o.append("<option value=\"?\">?</option>");

							select_p.trigger('change');
						}
					}
					update("s_change");
				}

				// Select for S
				var select_s = generate_select(mapping, s_change, "actors");
				div_s.append(select_s);
				select_s.trigger('change');
				return div_spo;
			}

			var mapping = module.mapping;

			// Add new menu
			var li = $('<li><a href="#tab' + modid + '" data-toggle="tab">' + module.title + '</a></li>');
			$("#tab-tabs li:last").after(li);

			// Add new content pane
			var div = $("<div class=\"tab-pane\" id=\"tab" + modid +  "\"></div>");
			$("#tab-content").append(div);

			// RUles
			div.append("<h4>Rules</h4>");

			// Set to active, if configured
			if(module.isActive) {
				div.addClass("active");
				li.addClass("active");
			}

			// Add [+]-Button to the content pane
			var input = $("<input class=\"btn\" type=\"button\" value=\"+\">");
			input.click(function(e) {
				div_rules.append(create(module.mapping, module.s));
				info_msg_rules.hide();
				update("input.click");
			});
			div.append(input);

			// Create a div, to keep all rules and add it to the content pane
			var div_rules = $("<div id=\"rules\" style=\"margin-top:5px;\"></div>");
			var info_msg_rules = $(create_info("No selection rule yet. Click the [+] button.", "no-rule-msg1", false)); // Empty message
			div_rules.append(info_msg_rules);
			div.append(div_rules);		

			div.append("<h4>Actors</h4>");

			var input2 = $("<input class=\"btn\" type=\"button\" value=\"+\">");
			input2.click(function(e) {
				div_actuation.append(create(module.mapping, module.s));
				info_msg_actuation.hide();
				update("nput2.click");
			});
			div.append(input2);

			var div_actuation = $("<div id=\"actuation\" style=\"margin-top:5px;\"></div>");
			var info_msg_actuation = $(create_info("No actuation rules yet. Click the [+] button.", "no-rule-msg2", false)); // Empty message
			div_actuation.append(info_msg_actuation);
			div.append(div_actuation);		

			div.append("<h4>Run</h4>");

			// Create a div to keep the save stuff and add it to the content pane
			var form = $('<form class="form-horizontal">');
			div.append(form);
			
			var div_rule = $("<div style=\"margin-top:5px;\" class=\"control-group\"><label class=\"control-label\">Rule Name:</label></div>");
			var div_rule_controls = $('<div class="controls"></div>');
			var input_rule_text = $("<input type=\"text\" placeholder=\"Rule name...\" class=\"span6\">");
			form.append(div_rule)
			div_rule.append(div_rule_controls);
			div_rule_controls.append(input_rule_text);

			var div_action = $("<div style=\"margin-top:5px;\" class=\"control-group\"><label class=\"control-label\">Action:</label></div>");
			var div_action_controls = $('<div class="controls"></div>');
			var select_action = $("<select id=\"action-value\"></select>");
			select_action.append($("<option value=\"on\">on</option>"));
			select_action.append($("<option value=\"off\">off</option>"));
			form.append(div_action)
			div_action.append(div_action_controls);
			div_action_controls.append(select_action);

			var div_button = $("<div style=\"margin-top:5px;\" class=\"control-group\"></div>");
			var div_button_controls = $('<div class="controls"></div>');
			var input_button_text = $("<button class=\"btn\" type=\"button\">Run query periodically</button>");
			var input_button_once =    $("<button class=\"btn\" type=\"button\">Run query once</button>");
			input_button_once.click(function(e) {
				update("input_button_once.click");
				run_query_once(query, requestHandlerOnce.success_once, requestHandlerOnce.error_once, requestHandlerOnce.async_once);
			});

			form.append(div_button)
			div_button.append(div_button_controls);
			div_button_controls.append(input_button_text);
			div_button_controls.append(" ");
			div_button_controls.append(input_button_once);

			//var input_save = $();

			function query_save() {

				if(query == null) {
					alert("You need at least one rule to run the query.");
					return;
				}
				if(input_rule_text.val().length == 0) {
					alert("You need a rule name to run the query.");
					return;
				}

				$("#tab-storage-link").click();

				var idx = queries.push([query, input_rule_text.val(), select_action.val(), null]);
				localStorage['saved_queries'] = JSON.stringify(queries);
				update_storage();
				run_query_periodically(query, select_action.val(), idx-1);
			}
			input_button_text.click(query_save);

		}

		function generate_sparql(spo, e) {

			var q = null;
			var hasActuator = false;
			var valCnt = 0;
			if(spo.length == 0) {
				e.show();
			} else {

				var ids = [];
				
				q = "";
				var actors = []; 
				for(var i = 0; i < spo.length; i++) {
					var children = spo[i].childNodes;

                    var tmp = "";

					for(var j = 0; j < children.length; j++) {
						var c = children[j];
						var v = $(c).attr("var");
						var e = $(c.firstChild);
						if(e.is("img")) break;
						var option = e.find("option:selected");
						var actor = option.attr("actors");
						if(typeof(actor) == "string" && actor != "") {
							actors.push(actor);
						}

						var val = e.val();

						var cont = false;

						if(typeof(v) == "string" && val.indexOf("{val}") >= 0) {
							if(val.indexOf("{val}") >= 0) {
								val = val.replace(new RegExp("{val}", "g"), "?" + v);
							}
                            tmp += val;
						} else if (val == "?") {
							tmp += "?val" + (++valCnt);
						} else if (typeof(v) != "string" && val.indexOf("{val}") >= 0) {
							var varx = "?val" + (++valCnt);
							if(val.indexOf("{val}") >= 0) {
								val = val.replace(new RegExp("{val}", "g"), varx);
							}
                            tmp += val;
						} else {
                            tmp += val;
						}
						
						tmp += " ";

					}

                    /*
                     * http://coding.pressbin.com/16/Javascript-equivalent-of-PHPs-pregmatchall
                     */
                    function preg_match_all(regex, haystack) {
                        var globalRegex = new RegExp(regex, 'g');
                        var globalMatch = haystack.match(globalRegex);
                        matchArray = new Array();
						if(globalMatch != null) {
		                    for(var gmi = 0; gmi < globalMatch.length; gmi++) {
		                        nonGlobalRegex = new RegExp(regex);
		                        nonGlobalMatch = globalMatch[gmi].match(nonGlobalRegex);
		                        matchArray.push(nonGlobalMatch[1]);
		                    }
						}
                        return matchArray;
                    }

                    var regex = '{([^"]*?)}';
                    var matches = preg_match_all(regex, tmp);

                    /*
                     * http://stackoverflow.com/a/15868720/605890
                     */
                    var uniq = matches.reduce(function(a,b){
                        if (a.indexOf(b) < 0 ) a.push(b);
                        return a;
                    },[]);

                    // Replace the vars
                    for(var k = 0; k<matches.length; k++) {
                        var varname = matches[k];
                        var varx = "?" + varname + (++valCnt);
                        tmp = tmp.replace(new RegExp("{" + varname + "}", "g"), varx);

                        // Check, if any actor is a variable as well
                        if(actors.length > 0) {
                            for(var aidx = 0; aidx < actors.length; aidx++) {
                                var actor = actors[aidx];
                                if(actor == "{" + varname + "}") {
                                    actors[aidx] = varx;
                                }
                            }
                        }
                    }

                    // Here, one line is complete
                    if(tmp.indexOf("<s>") >= 0) {
                        var varx = "?val" + (++valCnt);
                        tmp = tmp.replace(new RegExp("<s>", "g"), "" + varx + " ");
                    }

                    q += "\t" + tmp + " . \n";
				}

				q = "{\n" + q + "}";

				if(actors.length == 0) {
					hasActuator = false;
					console.log("Query does not contain any actor!");
					q = "SELECT DISTINCT * WHERE " + q;
				} else {
					hasActuator = true;
					q = "SELECT DISTINCT " + actors.join(" ") + " WHERE " + q;
				}
				console.log(q);
			}

			var result = new Object();
			result.hasActuator = hasActuator;
			result.query = q;

			return result;
		}

		function run_query_periodically(query, action, index) {

			function succ1(res) {
				success_periodically(res, action)
			}

			var funPerInterval1 = function () {
				run_query_once(query, succ1, error_periodically, function() {})
			}
			
			queries[index][3] = setInterval(funPerInterval1, 2000);
		}
/*
		function handleFileSelect(evt) {
			var files = evt.target.files;
			var output = [];
			for (var i = 0, f; f = files[i]; i++) {
				output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
				f.size, ' bytes, last modified: ',
				f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
				'</li>');
			}
			document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
		}
*/

		// Run action on url
		function action_request(url, action) {
			console.log("RUN ACTION ON " + url + " :: " + action);
			var xhr = new XMLHttpRequest();
			xhr.open('POST', url, true);
			xhr.responsetype = "text";

			xhr.onload = function(e) {
				lastStatus = this.status;
				console.log("onload == " + this.status);
				if (this.readyState == 4 && this.status == 200) {
					console.log(url + " + " + action + " DONE");
				} else if(this.readyState == 4){
					console.log(url + " + " + action + " ERROR");
				}
			}

			xhr.send(action);
		}

		// Run action for selected actors from Result
		function action_start() {
			var e = $("td.marked");
			for (var i = 0, i; i < e.length; i++) {
				var child = e[i].firstChild;
				action_request(child.data, $('#action-value').val());
			}
		}

		// Run querys from Query-Textbox
		function query_start() {
			var q1 = new Object();
			q1.query = $("#query-text1").val();

			var q2 = new Object();
			q2.query = $("#query-text2").val();
			q2.hasActuator = true;

			run_query_once([q1,q2], requestHandlerOnce.success_once, requestHandlerOnce.error_once, requestHandlerOnce.async_once);
		}
 
		// Run a query once
		function run_query_once(query, onsuccess, onerror, onasync, filter) {

			if(query[0].query == null) {
				alert("You need at least one selection rule to run the query.");
				return;				
			} else if(query[1].query == null) {
				alert("You need at least one actuation rule to run the query.");
				return;				
			} else if(!query[1].hasActuator) {
				alert("You need to define at least one actuator.");
				return;				
			}

			var succData = new Object();
			var url = config['sparqlEndpoint'] + "?query=";
			localStorage.setItem("query1", query[0].query);
			localStorage.setItem("query2", query[1].query);
			
			var onsuccessRules = function (res) {
				succData.rules = res;
				onsuccess(succData);
			}

			var onsuccessAction = function (res) {
				succData.action = res;
				onsuccess(succData);
			}

			var runxhr = function (url, query, onsuccess) {
				var encoded = urlencode(query);
				var path = url + encoded;

				var xhr = new XMLHttpRequest();
				xhr.responsetype = "text";
				xhr.open('GET', path, true);
				xhr.setRequestHeader("Accept", "application/xml");
				xhr.onload = function(e) {

					if (this.readyState == 4 && this.status == 200) {
						if(typeof(onsuccess) == "function") {
							onsuccess(this.response);
						}
					} else if (this.readyState == 4){
						consoel.log("Some error...")
					}
					/*
					TODO: Error handling
					else if (this.status == 504) {
						if(typeof(onerror) == "function") {
							onerror("CoAP timeout.");
						}
					} else {
						if(typeof(onerror) == "function") {
							onerror("HTTP-Status: " + this.status);
						}
					} 
					*/
				}

				xhr.send(null);
			}

			// Run two queries. 1) on rules 2) on actions
			if(query[0].query.length > 0) runxhr(url, query[0].query, onsuccessRules);
			if(query[1].query.length > 0) runxhr(url, query[1].query, onsuccessAction);

			if(typeof(onasync) == "function") {
				onasync();
			}
		}

	</script>
</head>
<body>

	<div class="container">
			<ul class="nav nav-tabs" id="tab-tabs">
				<!--
				<li><a href="#tab-import" data-toggle="tab">Module Import</a></li>
				-->
				<li><a href="#tab-config" data-toggle="tab">Config</a></li>
				<li><a href="#tab-query" data-toggle="tab">Query-Textbox</a></li>
				<li><a id="tab-storage-link" href="#tab-storage" data-toggle="tab">Query-Storage</a></li>
				<li><a id="tab-result-link" href="#tab-result" data-toggle="tab">Result</a></li>
			</ul>
			<div class="tab-content" id="tab-content">
				<!--
				<div class="tab-pane" id="tab-import">
					<p class="tab-content">
						<input type="file" id="files" name="files[]" multiple />
						<output id="list"></output>
					</p>
				</div>
				-->
				<div class="tab-pane" id="tab-query">
					<h3>Query</h3>
					<h4>Rules Query</h4>
					<textarea id="query-text1" style="width:97%;height:150px;"></textarea><br>
					<h4>Actors Query</h4>
					<textarea id="query-text2" style="width:97%;height:150px;"></textarea><br>
					<p><input class="btn" type="button" id="query-start" value="Run Query"></p>
				</div>
				<div class="tab-pane" id="tab-storage">
					<h3>Storage</h3>
					<p id="storage">...</p>
				</div>
				<div class="tab-pane" id="tab-config">
					<h3>Configuration</h3>
					<form class="form-horizontal">
					  <div class="control-group">
						<label for="config-lightThreshold" class="control-label">Light threshold:</label>
						<div class="controls">
						  <input type="text" placeholder="Threshold" id="config-lightThreshold">
						</div>
					  </div>
					  <div class="control-group">
						<label for="config-sparqlEndpoint" class="control-label">Sparql endpoint:</label>
						<div class="controls">
						  <input type="text" placeholder="http://..." id="config-sparqlEndpoint">
						</div>
					  </div>
					  <div class="control-group">
						<div class="controls">
						  <input type="input" id="saveConfig" class="btn" value="Save">
						</div>
					  </div>
					</form>					
				</div>
				<div class="tab-pane" id="tab-result">
					<h3>Result</h3>
					<p><input class="btn" type="button" id="query-restart" value="Rerun Query"></p>
					<h4>Result rules</h4>
					<p id="query-result-rules"></p>

					<h4>Result actors</h4>
					<p id="query-result-actors"></p>
					<h3>Actuation</h3>
					<p>
						<select id="action-value">
						  <option value="on">on</option>
						  <option value="off">off</option>
						</select>
						<br>
						<button class="btn" type="button" id="action-start">Run Actuation</button>
					</p>

				</div>
			</div>
	</div>
<!--
	<div id="footer">
		<img id="log-show" src="img/bullet_arrow_up.png">
		<img id="log-hide" src="img/bullet_arrow_down.png">
		<div id="log-div">
			<textarea id="log" style="width:97%;height:150px;"></textarea>
		</div>
	</div>
-->
</body>
</html>
