<!DOCTYPE html>
<html lang="en">
<head>
	<title>SPARQL Editor</title>
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/style.css" rel="stylesheet">
	<style>


	</style>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<!-- Page core -->
	<script src="js/jquery-latest.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<!-- Help functions-->
	<script src="js/urlencode.js"></script>
	<script src="js/remove.js"></script>
	<!-- Sparql GUI Setup-->
	<script src="js/dnd.js"></script>
	<script src="js/config.js"></script>

	<script>
		// Keeps the last action on an actor
		var lastAction = new Object();

		// Keeps the modules to be loaded.
		var modules = null;
		
		// Keeps all queries
		// [x][0] The SPARQL query
		// [x][1] Textual description
		// [x][2] Action command, e.g. ON/OFF
		// [x][3] Interval event
		var queries = [];




		function init_modules() {

			modules = {
				title : "Query-GUI",
				mapping :
							[
								[
									"node", "<val>",
									[
										["?", "?"],
										["measures", "<http://purl.oclc.org/NET/ssnx/ssn#attachedSystem>", 
											[
												["light ?",  "<val> .\n\t<val> <http://spitfire-project.eu/ontology/ns/obs> <http://spitfire-project.eu/property/Light> .\n\t<val> <http://spitfire-project.eu/ontology/ns/value> <val_>lightValue"],
												["light on",  "<val> .\n\t<val> <http://spitfire-project.eu/ontology/ns/obs> <http://spitfire-project.eu/property/Light> .\n\t<val> <http://spitfire-project.eu/ontology/ns/value> <val_>lightValue FILTER(<val_>lightValue >= " + config["light_threshold"] + ")"],
												["light off", "<val> .\n\t<val> <http://spitfire-project.eu/ontology/ns/obs> <http://spitfire-project.eu/property/Light> .\n\t<val> <http://spitfire-project.eu/ontology/ns/value> <val_>lightValue . FILTER(<val_>lightValue <= " + config["light_threshold"] + ")"],
											]
										],
										["has actor", "<http://purl.oclc.org/NET/ssnx/ssn#attachedSystem>", 
											[
												["?", "?hasA", "?hasA"],
												["fan","?fan .\n\t?fan <http://www.w3.org/2000/01/rdf-schema#type> <http://purl.oclc.org/NET/ssnx/ssn#Fan>", "?fan"],
												["radio","?radio.\n\t?radio <http://www.w3.org/2000/01/rdf-schema#type> <http://purl.oclc.org/NET/ssnx/ssn#Switch>", "?radio"]
											]
										],
										["is in","<http://purl.oclc.org/NET/ssnx/ssn#featureOfInterest>",
											[
												["?", "?featureOfInterest", "?featureOfInterest"],
												["kitchen", "<http://spitfire-project.eu/foi/kitchen>"],
												["living room", "<http://spitfire-project.eu/foi/livingroom>"]
											]
										],
									]
								],
								[
									"weather", "",
									[
										["temperatur is",              "<http://www.iti.uni-luebeck.de/time> <http://www.iti.uni-luebeck.de/is> ?time .\n\t?forecast <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://spitfire-project.eu/ontology/ns/sn/temperatureForecast> .\n\t?forecast <http://spitfire-project.eu/ontology/ns/sn/time_start> ?startForecast . FILTER(?time >= ?startForecast)\n\t?forecast <http://spitfire-project.eu/ontology/ns/sn/time_end> ?endForecast . FILTER(?time <= ?endForecast)\n\t?forecast <http://spitfire-project.eu/ontology/ns/value>", 
											[
												["?" , "?value2", "?value2"]
											]
										],
										["temperatur is greater than", "<http://www.iti.uni-luebeck.de/time>	<http://www.iti.uni-luebeck.de/is> ?time .\n\t?forecast <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://spitfire-project.eu/ontology/ns/sn/temperatureForecast> .\n\t?forecast <http://spitfire-project.eu/ontology/ns/sn/time_start> ?startForecast . FILTER(?time >= ?startForecast)\n\t?forecast <http://spitfire-project.eu/ontology/ns/sn/time_end> ?endForecast . FILTER(?time <= ?endForecast)\n\t?forecast <http://spitfire-project.eu/ontology/ns/value> ",
											[
												["10°C", "?temperatur . FILTER(?temperatur > 10)", "?temperatur"],
												["11°C", "?temperatur . FILTER(?temperatur > 11)", "?temperatur"],
												["12°C", "?temperatur . FILTER(?temperatur > 12)", "?temperatur"],
												["13°C", "?temperatur . FILTER(?temperatur > 13)", "?temperatur"],
												["14°C", "?temperatur . FILTER(?temperatur > 14)", "?temperatur"],
												["15°C", "?temperatur . FILTER(?temperatur > 15)", "?temperatur"],
												["16°C", "?temperatur . FILTER(?temperatur > 16)", "?temperatur"],
												["17°C", "?temperatur . FILTER(?temperatur > 17)", "?temperatur"],
												["18°C", "?temperatur . FILTER(?temperatur > 18)", "?temperatur"],
												["19°C", "?temperatur . FILTER(?temperatur > 19)", "?temperatur"],
												["20°C", "?temperatur . FILTER(?temperatur > 20)", "?temperatur", true],
												["21°C", "?temperatur . FILTER(?temperatur > 21)", "?temperatur"],
												["22°C", "?temperatur . FILTER(?temperatur > 22)", "?temperatur"],
												["23°C", "?temperatur . FILTER(?temperatur > 23)", "?temperatur"],
												["24°C", "?temperatur . FILTER(?temperatur > 24)", "?temperatur"],
												["25°C", "?temperatur . FILTER(?temperatur > 25)", "?temperatur"],
												["26°C", "?temperatur . FILTER(?temperatur > 26)", "?temperatur"],
												["27°C", "?temperatur . FILTER(?temperatur > 27)", "?temperatur"],
												["28°C", "?temperatur . FILTER(?temperatur > 28)", "?temperatur"],
												["29°C", "?temperatur . FILTER(?temperatur > 29)", "?temperatur"],
												["30°C", "?temperatur . FILTER(?temperatur > 30)", "?temperatur"],
											]
										],
										["temperatur is smaller than", "<http://www.iti.uni-luebeck.de/time>	<http://www.iti.uni-luebeck.de/is> ?time .\n\t?forecast <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://spitfire-project.eu/ontology/ns/sn/temperatureForecast> . \n\t?forecast <http://spitfire-project.eu/ontology/ns/sn/time_start> ?startForecast . FILTER(?time > ?startForecast)\n\t ?forecast <http://spitfire-project.eu/ontology/ns/sn/time_end> ?endForecast . FILTER(?time < ?endForecast)\n\t ?forecast <http://spitfire-project.eu/ontology/ns/temperatur> ",
											[
												["10°C", "?temperatur . FILTER(?temperatur < 10)", "?temperatur"],
												["11°C", "?temperatur . FILTER(?temperatur < 11)", "?temperatur"],
												["12°C", "?temperatur . FILTER(?temperatur < 12)", "?temperatur"],
												["13°C", "?temperatur . FILTER(?temperatur < 13)", "?temperatur"],
												["14°C", "?temperatur . FILTER(?temperatur < 14)", "?temperatur"],
												["15°C", "?temperatur . FILTER(?temperatur < 15)", "?temperatur"],
												["16°C", "?temperatur . FILTER(?temperatur < 16)", "?temperatur"],
												["17°C", "?temperatur . FILTER(?temperatur < 17)", "?temperatur"],
												["18°C", "?temperatur . FILTER(?temperatur < 18)", "?temperatur"],
												["19°C", "?temperatur . FILTER(?temperatur < 19)", "?temperatur"],
												["20°C", "?temperatur . FILTER(?temperatur < 20)", "?temperatur", true],
												["21°C", "?temperatur . FILTER(?temperatur < 21)", "?temperatur"],
												["22°C", "?temperatur . FILTER(?temperatur < 22)", "?temperatur"],
												["23°C", "?temperatur . FILTER(?temperatur < 23)", "?temperatur"],
												["24°C", "?temperatur . FILTER(?temperatur < 24)", "?temperatur"],
												["25°C", "?temperatur . FILTER(?temperatur < 25)", "?temperatur"],
												["26°C", "?temperatur . FILTER(?temperatur < 26)", "?temperatur"],
												["27°C", "?temperatur . FILTER(?temperatur < 27)", "?temperatur"],
												["28°C", "?temperatur . FILTER(?temperatur < 28)", "?temperatur"],
												["29°C", "?temperatur . FILTER(?temperatur < 29)", "?temperatur"],
												["30°C", "?temperatur . FILTER(?temperatur < 30)", "?temperatur"],
											]
										],
									]
								],[
									"calendar", "",
									[
										["has event", "<http://www.iti.uni-luebeck.de/time> <http://www.iti.uni-luebeck.de/is> ?time .\n\t ?event <http://spitfire-project.eu/ontology/ns/start> ?startCalendar . 		FILTER( ?time >= ?startCalendar)\n\t ?event <http://spitfire-project.eu/ontology/ns/end> ?endCalendar . 			FILTER( ?time <= ?endCalendar)\n\t ?event <http://spitfire-project.eu/ontology/ns/subject>", 
											[
												["?", "?event", "?event"],
												["radio","?eventSubject . FILTER regex(?eventSubject, 'Radio', 'i')"],
												["fan","?eventSubject . FILTER regex(?eventSubject, 'fan', 'i')"],
												["meeting","?eventSubject . FILTER regex(?eventSubject, 'meeting', 'i\'"],
											]
										]
									]
								]
							], 
				isActive : true
			}
		}

		window.onload = function () {

			// Get the config for the light threshold
			var threshold = localStorage.getItem("light_threshold");
			if(threshold != null) {
				config["light_threshold"] = threshold;
			} else {
				config["light_threshold"] = 3000;
			}
			$("#inputThreshold").val(config["light_threshold"]);

			// Get the last SPARQL query
			var query1 = localStorage.getItem("query1");
			if(query1 != null) {
				$('#query-text1').val(query1);
			}
			var query2 = localStorage.getItem("query2");
			if(query2 != null) {
				$('#query-text2').val(query2);
			}

			// Get all saves queries to rerun them
			var saved_queries = localStorage.getItem("saved_queries");
			if(saved_queries != null && saved_queries != "null") {
				queries = JSON.parse(saved_queries);
				update_storage();
				for(var i =0; i<queries.length;i++) {	
					var q = queries[i];
					run_periodically(q[0], q[2], i);
				}
			}

			// Init all modules
			init_modules();

			// Add modules
			addModules([modules]); //weather_module,modul2,modul3

			// Add event listeners
			//document.getElementById('files').addEventListener('change', handleFileSelect, false);
			document.getElementById('query-start').addEventListener('click', query_start, false);
			document.getElementById('query-restart').addEventListener('click', query_start, false);
			document.getElementById('action-start').addEventListener('click', action_start, false);

			$("#saveConfig").click(function() {
				var val = $("#inputThreshold").val();
				localStorage.setItem("light_threshold", val);
				init_modules();
				alert("Successful");
			});
		}

		function update_storage() {
			var ul = $("<ul>");
			for(var i = 0; i < queries.length; i++) {
				var q = queries[i];

				// Generate LI
				var li = $("<li>");
				var del_img = $("<img style=\"cursor:pointer;\" src=\"img/cancel.png\">");
				var onClick = function(i) {
					return function() {
						clearInterval(queries[i][3]);
						queries.remove(i);
						localStorage['saved_queries'] = JSON.stringify(queries);
						update_storage();
					}
				};

				del_img.click(onClick(i));
				li.append(del_img);
				li.append(q[1]);
				// Add LI
				ul.append(li);
			}
			$("#storage").html(ul);
		}

		var modid = 0;
		function addModules(modules) {
			for(var i = 0; i < modules.length; i++) {
				addModule(modules[i]);
			}
		}

		// data[0] what to show
		// data[1] what to map
		// event changeevent
		function generate_select(o, event, str) {
			var select = $('<select></select>');

			for(var j = 0; j<o.length; j++) {
				var option = "<option value=\"" + o[j][1] + "\" ";

				if(typeof(str) == "string" && typeof(o[j][2]) == "string") {
					option += "" + str + "=\"" + o[j][2] + "\" ";			
				}

				if(o[j][3] == true) {
					option += " selected";
				}
				option += ">" + o[j][0] + "</option>";
				select.append(option);
			}
			if(typeof(event) == "function") {
				select.change(event);
			}
			return select;
		}

		var query;
		var query_rules;
		var query_actions;

		function update(x) {
			query_rules = generate_sparql($("#rules .query-spo"), $("#no-rule-msg1"));
			query_actions = generate_sparql($("#actuation .query-spo"), $("#no-rule-msg2"));

			$("#query-text1").val(query_rules.query);
			$("#query-text2").val(query_actions.query);

			query = [query_rules,query_actions];
		}

		function generate_sparql(spo, e) {

			var q = null;
			var hasActuator = false;
			var valCnt = 0;
			if(spo.length == 0) {
				e.show();
			} else {

				var ids = [];
				
				q = "{\n";
				var actors = []; 
				for(var i = 0; i < spo.length; i++) {
					var children = spo[i].childNodes;
					for(var j = 0; j < children.length; j++) {
						var c = children[j];
						var v = $(c).attr("var");
						var e = $(c.firstChild);
						if(e.is("img")) break;
						var option = e.find("option:selected");
						var actor = option.attr("actors");
						if(typeof(actor) == "string") {
							actors.push(actor);
						}

						var val = e.val();

						var cont = false;

						if(typeof(v) == "string" && (val.indexOf("<val>") >= 0 || val.indexOf("<val_>") >= 0)) {

							if(val.indexOf("<val>") >= 0) {
								val = val.replace(new RegExp("<val>", "g"), "\t?" + v + " ");
							}

							if(val.indexOf("<val_>") >= 0) {
								val = val.replace(new RegExp("<val_>", "g"), "?" + v);
							}
							q += val;
							continue;
						}

						if (val == "?") {
							q += "\t?val" + (++valCnt) + " ";
						} else if (typeof(v) != "string" && (val.indexOf("<val>") >= 0 || val.indexOf("<val_>") >= 0)) {

							var varx = "?val" + (++valCnt);

							if(val.indexOf("<val>") >= 0) {
								val = val.replace(new RegExp("<val>", "g"), "\t" + varx + " ");
							}

							if(val.indexOf("<val_>") >= 0) {
								val = val.replace(new RegExp("<val_>", "g"), varx);
							}

							q += val;
						} else {
							q += "\t" + val + " ";
						}
					}

					q += ". \n";
				}

				q += "}";

				if(actors.length == 0) {
					hasActuator = false;
					console.log("Query does not contain any actor!");
					q = "SELECT DISTINCT * WHERE " + q;
				} else {
					hasActuator = true;
					q = "SELECT DISTINCT " + actors.join(" ") + " WHERE " + q;
				}
				console.log(q);
				update_log(q);
			}

			var result = new Object();
			result.hasActuator = hasActuator;
			result.query = q;

			return result;
		}

		function update_log(q) {
			$("#log").val(q);
		}



		function addModule(module) {
			modid++;

			var lineid = 0;

			var create = function(s_mapping, s) {

				var spo_id = "spo" + (lineid++);
				var div_spo = $("<div id=\"" + spo_id + "\" class=\"query-spo\"></div>");
				
				createimg = function() {
					return $("<img class=\"dnd\" src=\"img/arrow_in.png\">");
				}

				// SPO-divs
				var div_s = $("<div id=\"s" + lineid + "\" draggable=\"true\" class=\"box\"></div>"); //  style=\"padding:2px; border: 2px solid red;\"
				var div_p = $("<div id=\"p" + lineid + "\" draggable=\"true\" class=\"box\"></div>"); //  style=\"padding:2px; border: 2px solid blue;\"
				var div_o = $("<div id=\"o" + lineid + "\" draggable=\"true\" class=\"box\"></div>"); //  style=\"padding:2px; border: 2px solid green;\"

				var dnd = function(div) {
					div.bind('dragstart', handleDragStart);
					div.bind('dragend', handleDragEnd);
					div.bind('dragover', handleDragOver);
					div.bind('drop', handleDrop);
				}  

				dnd(div_s);
				dnd(div_p);
				dnd(div_o);

				var div_del = $("<span></span>");
				
				var del_img = $("<img style=\"cursor:pointer;\" src=\"img/cancel.png\">");
				del_img.click(function() { 
					$("#" + spo_id).remove();
					update();
				});
				div_del.append(del_img);

				// Append SPO-divs to main div
				div_spo.append(div_s);
				div_spo.append(div_p);
				div_spo.append(div_o);
				div_spo.append(div_del);

				var s_change = function() {
					var s_text = select_s.find("option:selected").text();

					for(var i = 0; i<s_mapping.length; i++) {
						if(s_mapping[i][0] == s_text) {
							var p_mapping = s_mapping[i][2];

							var p_change = function(e){
								var text = select_p.find("option:selected").text();
								var select_o = null;
								for(var i = 0; i<p_mapping.length; i++) {
									if(p_mapping[i][0] == text) {
										var o_change = function(e){
											update("oo");
										};
										var o_mapping = p_mapping[i][2];

										if(typeof(o_mapping) == "undefined") {
											select_o = generate_select([["?","?"]], o_change);
										} else {
											select_o = generate_select(o_mapping, o_change, "actors");
										}
									}
								}
								div_o.empty();
								div_o.append(select_o);
								update("pp");
							};
							var select_p = generate_select(p_mapping, p_change, "actors");
							div_p.empty();
							div_p.append(select_p);

							// Empty select for O
							var select_o = $('<select class="o"></select>');
							select_o.append("<option value=\"?\">?</option>");

							select_p.trigger('change');
						}
					}
					update("ss");
				}


				// Select for S
				var select_s = generate_select(mapping, s_change, "actors");
				div_s.append(select_s);
				select_s.trigger('change');
				return div_spo;
			}

			var mapping = module.mapping;

			// Add new menu
			var li = $('<li><a href="#tab' + modid + '" data-toggle="tab">' + module.title + '</a></li>');
			$("#tab-tabs li:last").after(li);

			// Add new content pane
			var div = $("<div class=\"tab-pane\" id=\"tab" + modid +  "\"></div>");
			$("#tab-content").append(div);

			// RUles
			div.append("<h4>Rules</h4>");

			// Set to active, if configured
			if(module.isActive) {
				div.addClass("active");
				li.addClass("active");
			}

			// Add [+]-Button to the content pane
			var input = $("<input class=\"btn\" type=\"button\" value=\"+\">");
			input.click(function(e) {
				div_rules.append(create(module.mapping, module.s));
				info_msg_rules.hide();
				update("line");
			});
			div.append(input);

			// Create a div, to keep all rules and add it to the content pane
			var div_rules = $("<div id=\"rules\" style=\"margin-top:5px;\"></div>");
			var info_msg_rules = $(info("No selection rule selected yet. Click the [+] button.", "no-rule-msg1", false)); // Empty message
			div_rules.append(info_msg_rules);
			div.append(div_rules);		

			div.append("<h4>Actuation</h4>");

			var input2 = $("<input class=\"btn\" type=\"button\" value=\"+\">");
			input2.click(function(e) {
				div_actuation.append(create(module.mapping, module.s));
				info_msg_actuation.hide();
				update("line");
			});
			div.append(input2);

			var div_actuation = $("<div id=\"actuation\" style=\"margin-top:5px;\"></div>");
			var info_msg_actuation = $(info("No actuation rules selected yet. Click the [+] button.", "no-rule-msg2", false)); // Empty message
			div_actuation.append(info_msg_actuation);
			div.append(div_actuation);		

			div.append("<h4>Run query</h4>");

			// Create a div to keep the save stuff and add it to the content pane
			var form = $('<form class="form-horizontal">');
			div.append(form);
			
			var div_rule = $("<div style=\"margin-top:5px;\" class=\"control-group\"><label class=\"control-label\">Rule Name:</label></div>");
			var div_rule_controls = $('<div class="controls"></div>');
			var input_rule_text = $("<input type=\"text\" placeholder=\"Rule name...\" class=\"span6\">");
			form.append(div_rule)
			div_rule.append(div_rule_controls);
			div_rule_controls.append(input_rule_text);

			var div_action = $("<div style=\"margin-top:5px;\" class=\"control-group\"><label class=\"control-label\">Action:</label></div>");
			var div_action_controls = $('<div class="controls"></div>');
			var select_action = $("<select id=\"action-value\"></select>");
			select_action.append($("<option value=\"on\">on</option>"));
			select_action.append($("<option value=\"off\">off</option>"));
			form.append(div_action)
			div_action.append(div_action_controls);
			div_action_controls.append(select_action);

			var div_button = $("<div style=\"margin-top:5px;\" class=\"control-group\"></div>");
			var div_button_controls = $('<div class="controls"></div>');
			var input_button_text = $("<button class=\"btn\" type=\"button\">Run query periodically</button>");
			var input_button_once =    $("<button class=\"btn\" type=\"button\">Run query once</button>");
			input_button_once.click(function(e) {
				update();
				query_run(query, success_once, error_once, async_once);
			});

			form.append(div_button)
			div_button.append(div_button_controls);
			div_button_controls.append(input_button_text);
			div_button_controls.append(" ");
			div_button_controls.append(input_button_once);

			//var input_save = $();

			function query_save() {
				if(query == null) {
					alert("You need at least one rule to run the query.");
					return;
				}
				if(input_rule_text.val().length == 0) {
					alert("You need a rule name to run the query.");
					return;
				}

				var idx = queries.push([query, input_rule_text.val(), select_action.val(), null]);
				localStorage['saved_queries'] = JSON.stringify(queries);
				update_storage();
				run_periodically(query, select_action.val(), idx-1);
			}
			input_button_text.click(query_save);

		}

		function run_periodically(query, action, index) {

			function succ1(res) {
				success_periodically(res, action)
			}

			var funPerInterval1 = function () {
				query_run(query, succ1, error_once, function() {})
			}
			
			queries[index][3] = setInterval(funPerInterval1, 2000);
		}


		function handleFileSelect(evt) {
			var files = evt.target.files;
			var output = [];
			for (var i = 0, f; f = files[i]; i++) {
				output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
				f.size, ' bytes, last modified: ',
				f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
				'</li>');
			}
			document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
		}

		function action_request(url, action) {
			console.log("RUN ACTION ON " + url + " :: " + action);
			var xhr = new XMLHttpRequest();
			xhr.open('POST', url, true);
			xhr.responsetype = "text";

			xhr.onload = function(e) {
				lastStatus = this.status;
				console.log("onload == " + this.status);
				if (this.status == 200) {
					console.log(url + " + " + action + " DONE");
				} else {
					console.log(url + " + " + action + " ERROR");
				}
			}

			xhr.send(action);
		}

		function action_start() {
			var e = $("td.marked");
			for (var i = 0, i; i < e.length; i++) {
				var child = e[i].firstChild;
				action_request(child.data, $('#action-value').val());
			}
		}

		function query_start() {
			var q1 = new Object();
			q1.query = $("#query-text1").val();

			var q2 = new Object();
			q2.query = $("#query-text2").val();
			q2.hasActuator = true;

			query_run([q1,q2], success_once, error_once, async_once);
		}
 


		function query_run(query, onsuccess, onerror, onasync, filter) {

			if(query[0].query == null) {
				alert("You need at least one selection rule to run the query.");
				return;				
			} else if(query[1].query == null) {
				alert("You need at least one actuation rule to run the query.");
				return;				
			} else if(!query[1].hasActuator) {
				alert("You need to define at least one actuator.");
				return;				
			}

			var succData = new Object();
			var url = config['sparqlEndpoint'] + "?query=";
			localStorage.setItem("query1", query[0].query);
			localStorage.setItem("query2", query[1].query);
			
			update_log(query[0].query + "\n\n==================================================\n\n" + query[1].query);

			var onsuccessRules = function (res) {
				succData.rules = res;
				onsuccess(succData);
			}

			var onsuccessAction = function (res) {
				succData.action = res;
				onsuccess(succData);
			}

			var xhr = function (url, query, onsuccess) {

				var encoded = urlencode(query);
				var path = url + encoded;

				var xhr = new XMLHttpRequest();
				xhr.responsetype = "text";
				xhr.open('GET', path, true);
				xhr.setRequestHeader("Accept", "application/xml");
				xhr.onload = function(e) {
					if (this.status == 200) {
						if(typeof(onsuccess) == "function") {
							onsuccess(this.response);
						}
					} 
					/*
					TODO: Error handling
					else if (this.status == 504) {
						if(typeof(onerror) == "function") {
							onerror("CoAP timeout.");
						}
					} else {
						if(typeof(onerror) == "function") {
							onerror("HTTP-Status: " + this.status);
						}
					} 
					*/
				}

				xhr.send(null);
			}

			if(query[0].query.length > 0) xhr(url, query[0].query, onsuccessRules);
			if(query[1].query.length > 0) xhr(url, query[1].query, onsuccessAction);

			if(typeof(onasync) == "function") {
				onasync();
			}
		}

		function async_once() {
			$('#query-result-rules').html(info("Query is running..."));  
			$('#query-result-actors').html(info("Query is running..."));  
			$("#tab-result-link").click();
		}

		function error_once(msg) {
			$('#query-result-rules').html(error(msg));
			$('#query-result-actors').html(error(msg));
		}

		function success_once(data) {
			if(typeof(data.rules) == "string") {
				generateTable($('#query-result-rules'), data.rules);
			}
			if(typeof(data.action) == "string") {
				generateTable($('#query-result-actors'), data.action);
			}
		}

		function generateTable(e, res) {
			e.html(success("Query successful."));
			var dom = new DOMParser().parseFromString(res,'text/xml');

			var title = [];
			var variables = dom.getElementsByTagName("variable");
			for(var i = 0; i < variables.length; i++) {
				var variable = variables[i];
				title.push(variable.getAttribute("name"));
			}
		
			var data = [];
			var results = dom.getElementsByTagName("result");

			for(var i = 0; i < results.length; i++) {
				var result = results[i];
				var bindings = result.getElementsByTagName("binding");

				var tmp = [];
				for(var k = 0; k < bindings.length; k++) {
					var binding = bindings[k];
					var children = binding.childNodes;
					for(var j = 0; j < children.length; j++) {
						var child = children[j];
						if(child.nodeType != 3) {
							var name = binding.getAttribute("name");
							var index = title.indexOf(name); 
							var c = child.firstChild;
							tmp[index] = c.data;
						}
					}
				}
				data.push(tmp);
			}

			var table = $('<table class="table table-striped table-hover table-condensed table-bordered"></table>');
			var thead = $('<thead></thead>');
			var tr = $('<tr></tr>');
			for(i=0; i<title.length; i++){
				var th = $('<th>' + title[i] + '</th>');
				tr.append(th);
			}
			thead.append(tr);
			table.append(thead);

			var onClick = function(e) {
				var t = $(this);						
				if(t.hasClass("marked")) {
					t.removeClass("marked");
				} else {
					t.addClass("marked");
				}
			}

			var tbody = $('<tbody></tbody>');
			for(i=0; i<data.length; i++){
				tr = $('<tr></tr>');
				for(j=0; j<data[i].length; j++){
					var td = null;
					if(typeof(data[i][j]) === "undefined") {
						td = $('<td></td>');
					} else {
						td = $('<td>' + data[i][j] + '</td>');
					}
					td.click(onClick);
					tr.append(td);
				}
				if(data[i].length < title.length) {
					var diff = title.length - data[i].length;
					console.log(diff);
					for(var y = 0; y< diff; y++) {
						tr.append($('<td></td>'));
					}
				}

				tbody.append(tr);
			}
			table.append(tbody);

			if(data.length == 0) {
				e.append(itm_alert("No data are matching the query."));
			} else {
				e.append(table);
			}
		}
	
		function success_periodically(data, action) {

			if(typeof(data.rules) != "string" || typeof(data.action) != "string") {
				return;
			}

			var dom1 = new DOMParser().parseFromString(data.rules,'text/xml');
			var results1 = dom1.getElementsByTagName("result");
			
			if(results1.length == 0) {
				if(action == "on") {
					action = "off";
				} else {
					action = "on";
				}
			}	
			console.log("Data for rules: " + results1.length);

			var dom = new DOMParser().parseFromString(data.action,'text/xml');

			var data = [];
			var results = dom.getElementsByTagName("result");

			for(var i = 0; i < results.length; i++) {
				var result = results[i];
				var bindings = result.getElementsByTagName("binding");un:

				var tmp = [];
				for(var k = 0; k < bindings.length; k++) {
					var binding = bindings[k];
					var children = binding.childNodes;
					for(var j = 0; j < children.length; j++) {
						var child = children[j];
						if(child.nodeType != 3) {
							var c = child.firstChild;
							if(typeof(lastAction[c.data]) == "string") {
								if(lastAction[c.data] != action) {
									console.log("RUN NEW COMMAND");
									action_request(c.data, action);
									lastAction[c.data] = action;
								} else {
									console.log("SKIP ACTION (LAST ACTION WAS THE SAME)");
								}
								continue;
							}
							console.log("RUN ACTION FIRST TIME");
							lastAction[c.data] = action;
							action_request(c.data, action);
						}
					}
				}
			}
		}

		function success(text) {
			return '<div class="alert alert-success"><button type="button" class="close" data-dismiss="alert">&times;</button>' + text + '</div>';
		}

		function info(text, id, showClose) {
			var x = '<button type="button" class="close" data-dismiss="alert">&times;</button>';
			if(showClose == false) {
				x = "";
			}

			if(typeof(id) == "string") {
				return '<div id=\"' + id + '\" class="alert alert-info">' + x + text + '</div>';
			} else {
				return '<div class="alert alert-info">' + x + text + '</div>';
			}
		}

		function itm_alert(text) {
			return '<div class="alert"><button type="button" class="close" data-dismiss="alert">&times;</button>' + text + '</div>';
		}

		function error(text) {
			return '<div class="alert alert-error"><button type="button" class="close" data-dismiss="alert">&times;</button><strong>ERROR!</strong>' + text + '</div>';
		}
	</script>
</head>
<body>

	<div class="container">
			<ul class="nav nav-tabs" id="tab-tabs">
				<!--
				<li><a href="#tab-import" data-toggle="tab">Module Import</a></li>
				-->
				<li><a href="#tab-config" data-toggle="tab">Config</a></li>
				<li><a href="#tab-query" data-toggle="tab">Query-Textbox</a></li>
				<li><a href="#tab-storage" data-toggle="tab">Query-Storage</a></li>
				<li><a id="tab-result-link" href="#tab-result" data-toggle="tab">Result</a></li>
			</ul>
			<div class="tab-content" id="tab-content">
				<!--
				<div class="tab-pane" id="tab-import">
					<p class="tab-content">
						<input type="file" id="files" name="files[]" multiple />
						<output id="list"></output>
					</p>
				</div>
				-->
				<div class="tab-pane" id="tab-query">
					<h3>Query</h3>
					<textarea id="query-text1" style="width:97%;height:150px;"></textarea><br>
					<textarea id="query-text2" style="width:97%;height:150px;"></textarea><br>
					<p><input type="button" id="query-start" value="Run Query"></p>
				</div>
				<div class="tab-pane" id="tab-storage">
					<h3>Storage</h3>
					<p id="storage">...</p>
				</div>
				<div class="tab-pane" id="tab-config">
					<h3>Configuration</h3>
					<form class="form-horizontal">
					  <div class="control-group">
						<label for="inputThreshold" class="control-label">Light threshold</label>
						<div class="controls">
						  <input type="text" placeholder="Threshold" id="inputThreshold">
						</div>
					  </div>
					  <div class="control-group">
						<div class="controls">
						  <input type="input" id="saveConfig" class="btn" value="Save">
						</div>
					  </div>
					</form>					
				</div>
				<div class="tab-pane" id="tab-result">
					<h3>Result</h3>
					<p><input type="button" id="query-restart" value="Run Query"></p>
					<h4>Result rules</h4>
					<p id="query-result-rules"></p>

					<h4>Result actors</h4>
					<p id="query-result-actors"></p>
					<h3>Actuation</h3>
					<p>
						<select id="action-value">
						  <option value="on">on</option>
						  <option value="off">off</option>
						</select>
						<br>
						<button type="button" id="action-start">Run Actuation</button>
					</p>

				</div>
			</div>
	</div>
<!--
	<div id="footer">
		<img id="log-show" src="img/bullet_arrow_up.png">
		<img id="log-hide" src="img/bullet_arrow_down.png">
		<div id="log-div">
			<textarea id="log" style="width:97%;height:150px;"></textarea>
		</div>
	</div>
-->
</body>
</html>
