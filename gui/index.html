<!DOCTYPE html>
<html lang="en">
<head>
	<title>SPARQL Editor</title>
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/style.css" rel="stylesheet">
	<style>


	</style>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<script src="js/jquery-latest.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/config.js"></script>
	<script src="js/urlencode.js"></script>
	<script src="js/xml2json.js"></script>

	<script>

		var config = [];
		config["light_threshhold"] = 3000;

		var sensor_module = {
			title : "Query-GUI",
			mapping :
						[
							[
								"?", "?",
								[
									["?", "?",
										[
											["?", "?"]
										]
									]
								]
							],
							[
								"sensor", "<val>",
								[
									["?", "?"],
									["has a", "<http://purl.oclc.org/NET/ssnx/ssn#attachedSystem>", 
										[
											["?", "?hasA", "?hasA"],
											["light sensor","<val> .\n\t<val> <http://spitfire-project.eu/ontology/ns/obs>  <http://spitfire-project.eu/property/Light>"],
											["fan","?fan .\n\t?fan <http://www.w3.org/2000/01/rdf-schema#type> <http://purl.oclc.org/NET/ssnx/ssn#Fan>", "?fan"],
											["radio","?radio.\n\t?radio <http://www.w3.org/2000/01/rdf-schema#type> <http://purl.oclc.org/NET/ssnx/ssn#Switch>", "?radio"]
										]
									],
									["is in","<http://purl.oclc.org/NET/ssnx/ssn#featureOfInterest>",
										[
											["?", "?featureOfInterest", "?featureOfInterest"],
											["kitchen", "<http://spitfire-project.eu/foi/kitchen>"],
											["living room", "<http://spitfire-project.eu/foi/livingroom>"]
										]
									],
		/*
									["has type", "<http://www.w3.org/2000/01/rdf-schema#type>",
										[
											["?", "?type"],
											["fan", "<http://purl.oclc.org/NET/ssnx/ssn#Fan>"],
											["switch", "<http://purl.oclc.org/NET/ssnx/ssn#Switch>"]
										]
									],
									["has value", "<http://spitfire-project.eu/ontology/ns/value>",
										[
											["?", "?value"]
										]
									],
		*/
								],
							],
							[
								"light", "<val>",
								[
									["is turned", "<http://spitfire-project.eu/ontology/ns/value>  ",
										[
											["?",   "?lightValue", "?lightValue"],
											["on",  "?lightValue . FILTER(?lightValue <bigger>= " + config["light_threshhold"] + ")"], // "200"^^xsd:int
											["off", "?lightValue . FILTER(?lightValue <smaller> " + config["light_threshhold"] + ")"]
										]
									],
								]
							],
							[
								"weather", "",
								[
									["is", "<http://www.iti.uni-luebeck.de/time> <http://www.iti.uni-luebeck.de/is> ?time .\n\t?forecast <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://spitfire-project.eu/ontology/ns/sn/temperatureForecast> .\n\t?forecast <http://spitfire-project.eu/ontology/ns/sn/time_start> ?startForecast . FILTER(?time >= ?startForecast)\n\t?forecast <http://spitfire-project.eu/ontology/ns/sn/time_end> ?endForecast . FILTER(?time <= ?endForecast)\n\t?forecast <http://spitfire-project.eu/ontology/ns/value>", 
										[
											["?" , "?value2", "?value2"]
										]
									],
									["temperatur is greater than", "<http://www.iti.uni-luebeck.de/time>	<http://www.iti.uni-luebeck.de/is> ?time .\n\t?forecast <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://spitfire-project.eu/ontology/ns/sn/temperatureForecast> .\n\t?forecast <http://spitfire-project.eu/ontology/ns/sn/time_start> ?startForecast . FILTER(?time >= ?startForecast)\n\t?forecast <http://spitfire-project.eu/ontology/ns/sn/time_end> ?endForecast . FILTER(?time <= ?endForecast)\n\t?forecast <http://spitfire-project.eu/ontology/ns/value> ?value . ",
										[
											["10°C", "FILTER(?value > 10)"],
											["11°C", "FILTER(?value > 11)"],
											["12°C", "FILTER(?value > 12)"],
											["13°C", "FILTER(?value > 13)"],
											["14°C", "FILTER(?value > 14)"],
											["15°C", "FILTER(?value > 15)"],
											["16°C", "FILTER(?value > 16)"],
											["17°C", "FILTER(?value > 17)"],
											["18°C", "FILTER(?value > 18)"],
											["19°C", "FILTER(?value > 19)"],
											["20°C", "FILTER(?value > 20)"],
											["21°C", "FILTER(?value > 21)"],
											["22°C", "FILTER(?value > 22)"],
											["23°C", "FILTER(?value > 23)"],
											["24°C", "FILTER(?value > 24)"],
											["25°C", "FILTER(?value > 25)"],
											["26°C", "FILTER(?value > 26)"],
											["27°C", "FILTER(?value > 27)"],
											["28°C", "FILTER(?value > 28)"],
											["29°C", "FILTER(?value > 29)"],
											["30°C", "FILTER(?value > 30)"],
										]
									],
									["temperatur is smaller than", "<http://www.iti.uni-luebeck.de/time>	<http://www.iti.uni-luebeck.de/is> ?time . ?forecast <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://spitfire-project.eu/ontology/ns/sn/temperatureForecast> . ?forecast <http://spitfire-project.eu/ontology/ns/sn/time_start> ?startForecast . FILTER(?time >= ?startForecast) ?forecast <http://spitfire-project.eu/ontology/ns/sn/time_end> ?endForecast . FILTER(?time <= ?endForecast) ?forecast <http://spitfire-project.eu/ontology/ns/value> ?value . ",
										[
											["10°C", "FILTER(?value < 10)"],
											["11°C", "FILTER(?value < 11)"],
											["12°C", "FILTER(?value < 12)"],
											["13°C", "FILTER(?value < 13)"],
											["14°C", "FILTER(?value < 14)"],
											["15°C", "FILTER(?value < 15)"],
											["16°C", "FILTER(?value < 16)"],
											["17°C", "FILTER(?value < 17)"],
											["18°C", "FILTER(?value < 18)"],
											["19°C", "FILTER(?value < 19)"],
											["20°C", "FILTER(?value < 20)"],
											["21°C", "FILTER(?value < 21)"],
											["22°C", "FILTER(?value < 22)"],
											["23°C", "FILTER(?value < 23)"],
											["24°C", "FILTER(?value < 24)"],
											["25°C", "FILTER(?value < 25)"],
											["26°C", "FILTER(?value < 26)"],
											["27°C", "FILTER(?value < 27)"],
											["28°C", "FILTER(?value < 28)"],
											["29°C", "FILTER(?value < 29)"],
											["30°C", "FILTER(?value < 30)"],
										]
									],
								]
							]
						], 
			isActive : true
		}

		// @see: http://stackoverflow.com/a/9815010
		// Array Remove - By John Resig (MIT Licensed)
		Array.prototype.remove = function(from, to) {
		  var rest = this.slice((to || from) + 1 || this.length);
		  this.length = from < 0 ? this.length + from : from;
		  return this.push.apply(this, rest);
		};


		var valCnt = 0;

		function showlog() {
			$("#log-div").show();
			$("#log-hide").show();
			$("#log-show").hide();
			$("#footer").css("border-top", "2px solid darkgray");
			localStorage.setItem("showlog", true);
		}

		function hidelog() {
			$("#log-div").hide();
			$("#log-hide").hide();
			$("#log-show").show();
			$("#footer").css("border-top", "");
			localStorage.setItem("showlog", false);
		}

		window.onload = function () {
			$("#log-div").hide();
			$("#log-hide").hide();
			// Add modules
			addModules([sensor_module]); //weather_module,modul2,modul3

			// Add event listeners
			//document.getElementById('files').addEventListener('change', handleFileSelect, false);
			document.getElementById('query-start').addEventListener('click', query_start, false);
			//document.getElementById('query-save').addEventListener('click', query_save, false);
			document.getElementById('action-start').addEventListener('click', action_start, false);
			document.getElementById('log-show').addEventListener('click', showlog, false);
			document.getElementById('log-hide').addEventListener('click', hidelog, false);

			// Get the last SPARQL query
			var q = localStorage.getItem("query");
			if(q != null) {
				$('#query-text').val(q);
			}

			var show_log = localStorage.getItem("showlog");
			if(show_log != null) {
				if(show_log == true || show_log == "true") {
					//showlog();
					$("#log-show").click();
				}
			}

			var saved_queries = localStorage.getItem("saved_queries");
			if(saved_queries != null && saved_queries != "null") {
				queries = JSON.parse(saved_queries);
				update_storage();
				for(var i =0; i<queries.length;i++) {	
					var q = queries[i];
					run_periodically(q[0], q[2]);
				}
			}
		}

		function update_storage() {
			var ul = $("<ul>");
			for(var i = 0; i < queries.length; i++) {
				var q = queries[i];

				// Generate LI
				var li = $("<li>");
				var del_img = $("<img style=\"cursor:pointer;\" src=\"img/cancel.png\">");
				var onClick = function(i) {
					return function() { 
						queries.remove(i);
						localStorage['saved_queries'] = JSON.stringify(queries);
						update_storage();
					}
				};

				del_img.click(onClick(i));
				li.append(del_img);
				li.append(q[1]);
				// Add LI
				ul.append(li);
			}
			$("#storage").html(ul);
		}

		var modid = 0;
		function addModules(modules) {
			for(var i = 0; i < modules.length; i++) {
				addModule(modules[i]);
			}
		}

		// data[0] what to show
		// data[1] what to map
		// event changeevent
		function generate_select(o, event, str) {
			//console.log("generate_select")

			var select = $('<select></select>');
			//select.append("<option value=\"?\">?</option>");

			for(var j = 0; j<o.length; j++) {
				if(typeof(str) == "string" && typeof(o[j][2]) == "string") {
					select.append("<option " + str + "=\"" + o[j][2] + "\" value=\"" + o[j][1] + "\">" + o[j][0] + "</option>");					
				} else {
					select.append("<option value=\"" + o[j][1] + "\">" + o[j][0] + "</option>");
				}
			}
			if(typeof(event) == "function") {
				select.change(event);
			}
			return select;
		}

		var query = null;

		function update(x) {
			//console.log("UPDATE " + x);
			var spo = $(".query-spo");
			if(spo.length == 0) {
				query = null;
				var e = $("#no-rule-msg");
				e.show();
			} else {

				var ids = [];
				
				//var tmp_lines = lines;
				//tmp_lines[0] = null;

				query = "{\n";
				var actors = []; 
				for(var i = 0; i < spo.length; i++) {
					var children = spo[i].childNodes;
					for(var j = 0; j < children.length; j++) {
						var c = children[j];
						var v = $(c).attr("var");
						var e = $(c.firstChild);
						if(e.is("img")) break;
						var option = e.find("option:selected");
						var actor = option.attr("actors");
						if(typeof(actor) == "string") {
							actors.push(actor);
						}

						var val = e.val();

						if(val.indexOf("<val>") >= 0) {
							if(typeof(v) == "string") {
								query += val.replace(new RegExp("<val>", "g"), "\t?" + v + " ");
								continue;
							}
						}

						if (val == "?") {
							query += "\t?val" + (++valCnt) + " ";
						} else if (val.indexOf("<val>") >= 0) {
							query += val.replace(new RegExp("<val>", "g"), "\t?val" + (++valCnt) + " ");
						} else {
							query += "\t" + val + " ";
						}
					}
					query += ". \n";
				}

				query += "}";

				if(actors.length == 0) {
					console.log("Query does not contain any actor!");
					query = "SELECT DISTINCT * WHERE " + query;
				} else {
					query = "SELECT DISTINCT " + actors.join(" ") + " WHERE " + query;
				}
				update_log(query);
			}

		}

		function update_log(query) {
			//console.log(query);
			$("#log").val(query);
		}

		var dragedObject = null;
		var lines = [];

		var colors = ["#FFFF00","#FF00FF","#FF0000","#C0C0C0","#80808","#808000","#800080","#800000","#00FFFF","#00FF00","#008080","#008000","#0000FF","#000080","#000000"];
		var colorID = 0;
		var varIndex = 0;

		function drawLine(from_, to_) {
			if(from_ == to_) return;

			var id_from = $('#' + from_);
			var id_to = $('#' + to_);

			console.log("CONNECT " + from_ + " with " + to_);

			//var from = Math.min(from_, to_);
			//var to = Math.max(from_, to_);

			var from = from_;
			var to = to_
			if(to_ > from_) {
				from = to_;
				to = from_;
			} 

			for(var i = 0; i < lines.length; i++) {
				l = lines[i];
				if(l[0] == from && l[1] == to) {
					return false;
				}
			}

			var exists = false;
			for(var i = 0; i < lines.length; i++) {
				l = lines[i];
				if(l[0] == from || l[1] == to || l[1] == from || l[0] == to) {
					exists = true;
					break;
				}
			}
	
			if(exists) {
				col = l[3];
				v = l[2];
				id_from.css("background-color", col);
				id_to.css("background-color", col);
				id_from.attr("var",v);
				id_to.attr("var",v);
			} else {
				col = colors[colorID++];
				v = "var" + (varIndex++);
				id_from.css("background-color", col);
				id_to.css("background-color", col);
				id_from.attr("var",v);
				id_to.attr("var",v);
				if(colorID == colors.length) colorID = 0;
			}

			var arr = [];
			arr[0] = from;
			arr[1] = to;
			arr[2] = v;
			arr[3] = col;

			lines.push(arr);
			update();
			return true;
		}

		function handleDragStart(e) {
			//console.log("Drag of " + this.getAttribute('id') + " element starts");
			dragedObject = {};
			dragedObject.obj = this;
			dragedObject.isSrc = true;
			$(this).css("opacity", "0.6");


			//$(this).css("background-color", "#CCC");

			// Hack: to get drag working in FF
			e.originalEvent.dataTransfer.setData('x', null);
		}

		function handleDragEnd(e) {
			//console.log("Drag of " + dragedObject.obj.getAttribute('id') + " element ends");
			$(this).css("opacity", "1");
			//$(this).css("background-color", "#FFF");
			dragedObject.obj = null;

			var elem = document.querySelectorAll('.box');

			[].forEach.call(elem, function (col) {
				col.classList.remove('over');
			});

		}

		function handleDragEnter(e) {
			if(dragedObject.obj == null) return;
			//this.classList.add('over');
			//console.log("Drag " + dragedObject.obj.getAttribute('id') + " enters " + this.getAttribute('id'));
			//this.classList.add('over');
		}

		function handleDragLeave(e) {
			if(dragedObject.obj == null) return;
			//this.classList.remove('over');
			//console.log("Drag " + dragedObject.obj.getAttribute('id') + " leaves " + this.getAttribute('id'));
			//this.classList.remove('over');
		}

		function handleDragOver(e) {
			if(dragedObject.obj == null) return;
			if (e.preventDefault) {
				e.preventDefault();
			}

			//console.log("Drag " + dragedObject.obj.getAttribute('id') + " over " + this.getAttribute('id'));
			//if (e.preventDefault) {
			//	e.preventDefault();
			//}
			//return false;
		}

		function handleDrop(e) {
//			console.log("handleDrop");
			var id1 = dragedObject.obj.getAttribute("id");
			var id2 = this.getAttribute("id");
			var bool = drawLine(id1, id2);
			console.log(bool);
		}


		function addModule(module) {
			modid++;

			var lineid = 0;

			var create = function(s_mapping, s) {

				var spo_id = "spo" + (lineid++);
				var div_spo = $("<div id=\"" + spo_id + "\" class=\"query-spo\"></div>");
				
				createimg = function() {
					var img = $("<img class=\"dnd\" src=\"img/arrow_in.png\">");
					/*
					img.mousedown(function(e){
						e.stopPropagation();
						e.preventDefault();
					});
					*/
					//img.bind('dragstart', function(event) { event.preventDefault(); });
					return img;
				}

				// SPO-divs
				var div_s = $("<div id=\"s" + lineid + "\" draggable=\"true\" class=\"box\"></div>"); //  style=\"padding:2px; border: 2px solid red;\"
				var div_p = $("<div id=\"p" + lineid + "\" draggable=\"true\" class=\"box\"></div>"); //  style=\"padding:2px; border: 2px solid blue;\"
				var div_o = $("<div id=\"o" + lineid + "\" draggable=\"true\" class=\"box\"></div>"); //  style=\"padding:2px; border: 2px solid green;\"

				//div_s.append(createimg);
				//div_p.append(createimg);
				//div_o.append(createimg);

				var dnd = function(div) {
					div.bind('dragstart', handleDragStart);		// OK
					div.bind('dragend', handleDragEnd);			// OK
					div.bind('dragenter', handleDragEnter);		// OK
					div.bind('dragover', handleDragOver);		// OK
					div.bind('dragleave', handleDragLeave);		// OK
					div.bind('drop', handleDrop);
				}  

				dnd(div_s);
				dnd(div_p);
				dnd(div_o);

				var div_del = $("<span></span>"); //  style=\"padding:2px; border: 2px solid green;\"
				
				var del_img = $("<img style=\"cursor:pointer;\" src=\"img/cancel.png\">");
				del_img.click(function() { 
					$("#" + spo_id).remove();
					update();
				});
				div_del.append(del_img);

				// Append SPO-divs to main div
				div_spo.append(div_s);
				div_spo.append(div_p);
				div_spo.append(div_o);
				div_spo.append(div_del);

				var s_change = function() {
					var s_text = select_s.find("option:selected").text();

					for(var i = 0; i<s_mapping.length; i++) {
						if(s_mapping[i][0] == s_text) {
							var p_mapping = s_mapping[i][2];

							var p_change = function(e){
								var text = select_p.find("option:selected").text();
								var select_o = null;
								for(var i = 0; i<p_mapping.length; i++) {
									if(p_mapping[i][0] == text) {
										var o_change = function(e){
											update("oo");
										};
										var o_mapping = p_mapping[i][2];

										if(typeof(o_mapping) == "undefined") {
											select_o = generate_select([["?","?"]], o_change);
										} else {
											select_o = generate_select(o_mapping, o_change, "actors");
										}
									}
								}
								div_o.empty();
								//div_o.append(createimg);
								div_o.append(select_o);
								update("pp");
							};
							var select_p = generate_select(p_mapping, p_change, "actors");
							div_p.empty();
							//div_p.append(createimg);
							div_p.append(select_p);

							// Empty select for O
							var select_o = $('<select class="o"></select>');
							select_o.append("<option value=\"?\">?</option>");

							//select_p.change();
							select_p.trigger('change');
						}
					}
					update("ss");
				}


				// Select for S
				var select_s = generate_select(mapping, s_change, "actors");
				div_s.append(select_s);
				select_s.trigger('change');
				return div_spo;
			}

			var mapping = module.mapping;

			// Add new menu
			var li = $('<li><a href="#tab' + modid + '" data-toggle="tab">' + module.title + '</a></li>');
			$("#tab-tabs li:last").after(li);

			// Add new content pane
			var div = $("<div class=\"tab-pane\" id=\"tab" + modid +  "\"></div>");
			$("#tab-content").append(div);

			// RUles
			div.append("<h4>Rules</h4>");

			// Set to active, if configured
			if(module.isActive) {
				div.addClass("active");
				li.addClass("active");
			}

			// Add [+]-Button to the content pane
			var input = $("<input class=\"btn\" type=\"button\" value=\"+\">");
			input.click(function(e) {
				div_rules.append(create(module.mapping, module.s));
				info_msg.hide();
				update("line");
			});
			div.append(input);

			// Create a div, to keep all rules and add it to the content pane
			var div_rules = $("<div style=\"margin-top:5px;\"></div>");
			var info_msg = $(info("No rule selected yet. Click the [+] button.", "no-rule-msg", false)); // Empty message
			div_rules.append(info_msg);
			div.append(div_rules);		

			div.append("<h4>Run once</h4>");

			// Add [Run Query]-Button to the content pane
			var input_generate = $("<input class=\"btn\" type=\"button\" value=\"Run Query\">");
			input_generate.click(function(e) {
				query_run(query, success_once, error_once, async_once);
			});
			div.append(input_generate);

			/*
			// Add [Run Query Peridically]-Button to the content pane
			var input_periodically = $("<input class=\"btn\" type=\"button\" value=\"Run Query Periodically in the background\"> ");
			input_periodically.click(function(e) {
				console.log("Run periodically");
				//query_run(query);
			});
			div.append(input_periodically);
			*/

			div.append("<h4>Run periodically in the background</h4>");

			// Create a div to keep the save stuff and add it to the content pane
			var form = $('<form class="form-horizontal">');
			div.append(form);
			
			var div_rule = $("<div style=\"margin-top:5px;\" class=\"control-group\"><label class=\"control-label\">Rule Name:</label></div>");
			var div_rule_controls = $('<div class="controls"></div>');
			var input_rule_text = $("<input type=\"text\" placeholder=\"Rule name...\" class=\"span6\">");
			form.append(div_rule)
			div_rule.append(div_rule_controls);
			div_rule_controls.append(input_rule_text);

			var div_action = $("<div style=\"margin-top:5px;\" class=\"control-group\"><label class=\"control-label\">Action:</label></div>");
			var div_action_controls = $('<div class="controls"></div>');
			var select_action = $("<select id=\"action-value\"></select>");
			select_action.append($("<option value=\"on\">on</option>"));
			select_action.append($("<option value=\"off\">off</option>"));
			form.append(div_action)
			div_action.append(div_action_controls);
			div_action_controls.append(select_action);

			var div_button = $("<div style=\"margin-top:5px;\" class=\"control-group\"></div>");
			var div_button_controls = $('<div class="controls"></div>');
			var input_button_text = $("<button class=\"btn\" type=\"button\">Run Query</button>");
			form.append(div_button)
			div_button.append(div_button_controls);
			div_button_controls.append(input_button_text);

			var input_save = $();

			function query_save() {
				if(query == null) {
					alert("You need at least one rule to run the query.");
					return;
				}
				if(input_rule_text.val().length == 0) {
					alert("You need a rule name to run the query.");
					return;
				}

				queries.push([query, input_rule_text.val(), select_action.val()]);
				localStorage['saved_queries'] = JSON.stringify(queries);
				update_storage();
				run_periodically(query, select_action.val());
			}
			input_button_text.click(query_save);

		}

		function run_periodically(query, action) {

			function succ1(res) {
				success_periodically(res, action)
			}

			function succ2(res) {
				if(action == "on") {
					success_periodically(res, "off");
				} else {
					success_periodically(res, "on");
				}
			}

			var funPerInterval1 = function () {
				query_run(query, succ1, error_once, function() {})
			}

			var funPerInterval2 = function () {
				query_run(query, succ2, error_once, function() {}, false)
			}

			setInterval(funPerInterval1, 2000);

			var startLater = function() {
				setInterval(funPerInterval2, 2000);
			}

			setTimeout(startLater,1000);
			
			/*
				function abortTimer() { // to be called when you want to stop the timer
				  clearInterval(tid);
				}
			*/			
			
		}


		function handleFileSelect(evt) {
			var files = evt.target.files;
			var output = [];
			for (var i = 0, f; f = files[i]; i++) {
				output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
				f.size, ' bytes, last modified: ',
				f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
				'</li>');
			}
			document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
		}

		function action_request(url, action) {
			console.log("RUN ACTION ON " + url + " :: " + action);
			var xhr = new XMLHttpRequest();
			xhr.open('POST', url, true);
			xhr.responsetype = "text";

			xhr.onload = function(e) {
				//clearTimeout(xmlHttpTimeout); 
				lastStatus = this.status;
				console.log("onload == " + this.status);
				if (this.status == 200) {
					console.log(url + " + " + action + " DONE");
				} else {
					console.log(url + " + " + action + " ERROR");
				}
			}

			xhr.send(action);

			// Workarount to get a timeout
			//@see: http://stackoverflow.com/a/1018731
			//var xmlHttpTimeout=setTimeout( function (){ console.log("TIMEOUT"); xhr.abort(); } , 20000);
		}

		function action_start() {
			var e = $("td.marked");
			for (var i = 0, i; i < e.length; i++) {
				var child = e[i].firstChild;
				action_request(child.data, $('#action-value').val());
			}
		}

		function query_start() {
			var query = $('#query-text').val();
			query_run(query, success_once, error_once, async_once);
		}

		var queries = [];

		function query_run(query, onsuccess, onerror, onasync, filter) {

			if(query == null) {
				alert("You need at least one rule to run the query.");
			}

			if(typeof(filter) == "boolean" && !filter) {
				query = query.replace(new RegExp("<filter>", "g"), "FILTER NOT EXISTS");
				query = query.replace(new RegExp("<bigger>", "g"), "<");
				query = query.replace(new RegExp("<smaller>", "g"), ">");
			} else {
				query = query.replace(new RegExp("<filter>", "g"), "FILTER");
				query = query.replace(new RegExp("<bigger>", "g"), ">");
				query = query.replace(new RegExp("<smaller>", "g"), "<");
			}

			var url = sparqlEndpoint + "?query=";
			localStorage.setItem("query", query);
			$("#query-text").val(query);
			
			//query = "SELECT * WHERE { " + query + " }";
			update_log(query);

//			var query = "SELECT ?ss ?o WHERE { ?ss <http://purl.oclc.org/NET/muo/muo#prefSymbol> ?o }";
			var encoded = urlencode(query);
			var path = url + encoded;

			var xhr = new XMLHttpRequest();
			xhr.responsetype = "text";
			xhr.open('GET', path, true);
			xhr.setRequestHeader("Accept", "application/xml");
			xhr.onload = function(e) {
				if (this.status == 200) {
					if(typeof(onsuccess) == "function") {
						onsuccess(this.response);
					}
				} else if (this.status == 504) {
					if(typeof(onerror) == "function") {
						onerror("CoAP timeout.");
					}
				} else {
					if(typeof(onerror) == "function") {
						onerror("HTTP-Status: " + this.status);
					}
				} 
			}

			xhr.send(null);
			if(typeof(onasync) == "function") {
				onasync();
			}
		}

		function async_once() {
			$('#query-result').html(info("Query is running..."));  
			$("#tab-result-link").click();
		}

		function error_once(msg) {
			$('#query-result').html(error(msg));
		}

		function success_once(res) {
			$('#query-result').html(success("Query successful."));
			var dom = new DOMParser().parseFromString(res,'text/xml');

			var title = [];
			var variables = dom.getElementsByTagName("variable");
			for(var i = 0; i < variables.length; i++) {
				var variable = variables[i];
				title.push(variable.getAttribute("name"));
			}
			//console.log(title);
		
			var data = [];
			var results = dom.getElementsByTagName("result");

			for(var i = 0; i < results.length; i++) {
				var result = results[i];
				var bindings = result.getElementsByTagName("binding");

				var tmp = [];
				for(var k = 0; k < bindings.length; k++) {
					var binding = bindings[k];
					var children = binding.childNodes;
					for(var j = 0; j < children.length; j++) {
						var child = children[j];
						if(child.nodeType != 3) {
							var name = binding.getAttribute("name");
							var index = title.indexOf(name); 
							var c = child.firstChild;
							tmp[index] = c.data;
/*
							if(child.nodeName == "uri") {
								tmp[index] = "&#60;" + c.data + "&#62;";
							} else {
								tmp[index] = c.data;
							}
*/
						}
					}
				}
				data.push(tmp);
			}
			//console.log(data);

			var table = $('<table class="table table-striped table-hover table-condensed table-bordered"></table>');
			var thead = $('<thead></thead>');
			var tr = $('<tr></tr>');
			for(i=0; i<title.length; i++){
				var th = $('<th>' + title[i] + '</th>');
				tr.append(th);
			}
			thead.append(tr);
			table.append(thead);

			var onClick = function(e) {
				var t = $(this);						
				if(t.hasClass("marked")) {
					t.removeClass("marked"); // css("color", "red");
				} else {
					t.addClass("marked"); // css("color", "red");
				}
			}

			var tbody = $('<tbody></tbody>');
			for(i=0; i<data.length; i++){
				tr = $('<tr></tr>');
				//console.log(data[i]);
				for(j=0; j<data[i].length; j++){
					var td = null;
					if(typeof(data[i][j]) === "undefined") {
						td = $('<td></td>');
					} else {
						td = $('<td>' + data[i][j] + '</td>');
					}
					td.click(onClick);
					tr.append(td);
				}
				if(data[i].length < title.length) {
					var diff = title.length - data[i].length;
					console.log(diff);
					for(var y = 0; y< diff; y++) {
						tr.append($('<td></td>'));
					}
				}

				tbody.append(tr);

				// title
			}
			table.append(tbody);

			if(data.length == 0) {
				$('#query-result').append(itm_alert("No data are matching the query."));
			} else {
				$('#query-result').append(table);
			}
		}

	
		function success_periodically(res, action) {
			var dom = new DOMParser().parseFromString(res,'text/xml');
		
			var data = [];
			var results = dom.getElementsByTagName("result");

			for(var i = 0; i < results.length; i++) {
				var result = results[i];
				var bindings = result.getElementsByTagName("binding");

				var tmp = [];
				for(var k = 0; k < bindings.length; k++) {
					var binding = bindings[k];
					var children = binding.childNodes;
					for(var j = 0; j < children.length; j++) {
						var child = children[j];
						if(child.nodeType != 3) {
							var c = child.firstChild;
							action_request(c.data, action);
						}
					}
				}
			}
		}

		function success(text) {
			return '<div class="alert alert-success"><button type="button" class="close" data-dismiss="alert">&times;</button>' + text + '</div>';
		}

		function info(text, id, showClose) {
			var x = '<button type="button" class="close" data-dismiss="alert">&times;</button>';
			if(showClose == false) {
				x = "";
			}

			if(typeof(id) == "string") {
				return '<div id=\"' + id + '\" class="alert alert-info">' + x + text + '</div>';
			} else {
				return '<div class="alert alert-info">' + x + text + '</div>';
			}
		}

		function itm_alert(text) {
			return '<div class="alert"><button type="button" class="close" data-dismiss="alert">&times;</button>' + text + '</div>';
		}

		function error(text) {
			return '<div class="alert alert-error"><button type="button" class="close" data-dismiss="alert">&times;</button><strong>ERROR!</strong>' + text + '</div>';
		}
	</script>
</head>
<body>

	<div class="container">
			<ul class="nav nav-tabs" id="tab-tabs">
				<!--
				<li><a href="#tab-import" data-toggle="tab">Module Import</a></li>
				-->
				<li><a href="#tab-query" data-toggle="tab">Query-Textbox</a></li>
				<li><a href="#tab-storage" data-toggle="tab">Query-Storage</a></li>
				<li><a id="tab-result-link" href="#tab-result" data-toggle="tab">Result</a></li>
			</ul>
			<div class="tab-content" id="tab-content">
				<!--
				<div class="tab-pane" id="tab-import">
					<p class="tab-content">
						<input type="file" id="files" name="files[]" multiple />
						<output id="list"></output>
					</p>
				</div>
				-->
				<div class="tab-pane" id="tab-query">
					<h3>Query</h3>
					<textarea id="query-text" style="width:97%;height:350px;"></textarea><br>
					<p><input type="button" id="query-start" value="Run Query"></p>
					<p><input type="button" id="query-save" value="Save Query"></p>
				</div>
				<div class="tab-pane" id="tab-storage">
					<h3>Storage</h3>
					<p id="storage">...</p>
				</div>
				<div class="tab-pane" id="tab-result">
					<h3>Result</h3>
					<p id="query-result"></p>
					<h3>Actuation</h3>
					<p>
						<select id="action-value">
						  <option value="on">on</option>
						  <option value="off">off</option>
						</select>
						<br>
						<input type="button" id="action-start" value="Run Actuation">
					</p>

				</div>
			</div>
	</div>
	<div id="footer">
		<img id="log-show" src="img/bullet_arrow_up.png">
		<img id="log-hide" src="img/bullet_arrow_down.png">
		<div id="log-div">
			<textarea id="log" style="width:97%;height:150px;"></textarea>
		</div>
	</div>
</body>
</html>
